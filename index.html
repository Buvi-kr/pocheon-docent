<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

    <style>
        /* --- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ & ë°°ê²½ --- */
        body { margin: 0; padding: 0; background: #0b0c15; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; height: 100vh; height: 100dvh; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at bottom, #1a237e 0%, #000000 80%); }
        .stars { position: fixed; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.5; z-index: 0; pointer-events: none; }

        /* --- 2. Live2D ìº”ë²„ìŠ¤ --- */
        #live2d-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: block; }

        /* --- 3. HUD (ëŒ€í™”ì°½) --- */
        .hud-area {
            position: fixed; top: 20px; left: 20px; height: 35vh; width: calc(100% - 40px); max-width: 350px; z-index: 10;
            display: flex; flex-direction: column; gap: 10px; overflow-y: auto; pointer-events: auto;
            -ms-overflow-style: none; scrollbar-width: none;
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
        }
        .hud-area::-webkit-scrollbar { display: none; }

        .zone-badge {
            align-self: flex-start; background: rgba(79, 195, 247, 0.2); border: 1px solid #4fc3f7; color: #4fc3f7;
            padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;
            backdrop-filter: blur(5px); box-shadow: 0 0 10px rgba(79, 195, 247, 0.3); flex-shrink: 0; 
        }

        .chat-bubble {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; color: #fff;
            font-size: 0.95rem; line-height: 1.5; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.4s ease-out; border-left: 3px solid transparent; flex-shrink: 0; 
        }
        .chat-bubble.user { border-left-color: #ff9800; align-self: flex-start; background: rgba(0, 0, 0, 0.4); color: #ffd180; }
        .chat-bubble.ai { border-left-color: #4fc3f7; align-self: flex-start; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        /* --- 4. í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ --- */
        .bottom-container {
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 20;
            display: flex; flex-direction: column; align-items: center;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
        }

        .choice-scroll-area {
            width: 100%; overflow-x: auto; white-space: nowrap; padding: 10px 15px; box-sizing: border-box;
            -webkit-overflow-scrolling: touch; scrollbar-width: none; display: flex; gap: 10px; justify-content: center;
        }
        .choice-scroll-area::-webkit-scrollbar { display: none; }

        .choice-btn {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255,0.3); color: white;
            padding: 10px 20px; border-radius: 25px; font-size: 0.9rem; cursor: pointer; backdrop-filter: blur(5px); transition: 0.2s; white-space: nowrap;
        }
        .choice-btn:active { transform: scale(0.95); background: #4fc3f7; color: black; border-color: #4fc3f7; }
        .choice-btn.move { border-color: #ff9800; color: #ff9800; background: rgba(255, 152, 0, 0.1); }

        .input-bar { width: calc(100% - 30px); max-width: 600px; display: flex; gap: 10px; margin-top: 5px; }

        .input-box {
            flex: 1; background: rgba(40, 40, 40, 0.8); border: 1px solid #555; border-radius: 25px;
            padding: 12px 20px; color: white; font-size: 1rem; outline: none; backdrop-filter: blur(5px);
        }
        .icon-btn {
            width: 48px; height: 48px; border-radius: 50%; border: none; color: white; font-size: 1.2rem;
            cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        #mic-btn { background: rgba(244, 67, 54, 0.8); }
        #mic-btn.listening { background: #4caf50; box-shadow: 0 0 15px #4caf50; animation: pulse 1.5s infinite; }
        #send-btn { background: rgba(63, 81, 181, 0.8); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- 5. ë””ë²„ê·¸ ì½˜ì†” --- */
        #debug-box {
            position: fixed; top: 10px; right: 10px; width: 300px; height: auto; max-height: 400px;
            background: rgba(0, 0, 0, 0.85); border: 1px solid #00ff00; color: #00ff00;
            font-family: 'Consolas', monospace; font-size: 11px; padding: 10px; z-index: 1000;
            overflow-y: auto; pointer-events: none; border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>
    <canvas id="live2d-canvas"></canvas>

    <div id="debug-box">ğŸ”§ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>

    <div class="hud-area" id="hud-container">
        <div class="zone-badge" id="zone-badge">ğŸ›ï¸ ë¡œë¹„</div>
        <div class="chat-bubble ai">
            ì•ˆë…•! ë‚˜ëŠ” AI ë„ìŠ¨íŠ¸ 'í•˜ë£¨'ì•¼! ğŸŒ¸<br>
            í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì— ì˜¨ ê±¸ í™˜ì˜í•´.<br>
            ê¶ê¸ˆí•œ ê²Œ ìˆìœ¼ë©´ í¸í•˜ê²Œ ë¬¼ì–´ë´!
        </div>
    </div>

    <div class="bottom-container">
        <div class="choice-scroll-area" id="choice-container"></div>
        <div class="input-bar">
            <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
            <input type="text" class="input-box" id="text-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
            <button class="icon-btn" id="send-btn">â¤</button>
        </div>
    </div>

    <script type="module">
        import { exhibitionData } from './knowledge.js';

        // --- Live2D ì„¤ì • (í•˜ë£¨ ëª¨ë¸) ---
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/Live2D/CubismWebSamples@develop/Samples/Resources/Haru/Haru.model3.json';
        let live2dApp = null;
        let live2dModel = null;
        let mouthAnimId = null; // requestAnimationFrame ID

        // ë””ë²„ê·¸ ë¡œê·¸
        function logDebug(title, data) {
            const box = document.getElementById('debug-box');
            let text = `[${title}]\n`;
            if (typeof data === 'object') text += JSON.stringify(data, null, 2);
            else text += data;
            box.innerText = text + "\n----------------\n" + box.innerText;
        }

        async function initLive2D() {
            try {
                live2dApp = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    autoStart: true, resizeTo: window, backgroundAlpha: 0 
                });

                if(!window.PIXI.live2d) throw new Error("Plugin not loaded");
                live2dModel = await PIXI.live2d.Live2DModel.from(MODEL_URL);

                resizeModel();

                live2dApp.stage.addChild(live2dModel);
                live2dModel.interactive = true;
                
                // í„°ì¹˜ ì‹œ ë°˜ì‘
                live2dModel.on('pointertap', () => {
                    performMotion();
                    speak("í—¤í—¤, ìš°ì£¼ëŠ” ì •ë§ ì‹ ë¹„ë¡œì›Œ!");
                });

                // â˜… [í•µì‹¬] ë¡œë”© ì™„ë£Œ í›„ 'ì›ƒëŠ” í‘œì •(F01)' ì˜êµ¬ ê³ ì •
                setTimeout(() => {
                    if(live2dModel) {
                        try { live2dModel.expression("F01"); } catch(e){}
                        logDebug("INIT", "ê¸°ë³¸ í‘œì •(F01) ì„¤ì • ì™„ë£Œ");
                    }
                }, 1000);

                logDebug("SYSTEM", "Live2D(Haru) ì´ˆê¸°í™” ì™„ë£Œ");
            } catch (e) { console.error(e); logDebug("ERROR", "Live2D ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
        }

        function resizeModel() {
            if (!live2dModel) return;
            const isMobile = window.innerWidth < 800; 
            live2dModel.anchor.set(0.5, 0);
            live2dModel.x = window.innerWidth / 2;
            if (isMobile) {
                live2dModel.scale.set(0.42);
                live2dModel.y = window.innerHeight * 0.15;
            } else {
                live2dModel.scale.set(0.50);
                live2dModel.y = window.innerHeight * 0.05;
            }
        }
        window.addEventListener('resize', resizeModel);
        initLive2D();

        // --- ë™ì‘ (ì‹¬í”Œ) ---
        function performMotion() {
            if(!live2dModel) return;
            try {
                // í•˜ë£¨ ëª¨ë¸ì˜ ê¸°ë³¸ ì œìŠ¤ì²˜ 'TapBody' í•˜ë‚˜ë§Œ ì‚¬ìš©
                live2dModel.motion('TapBody');
            } catch(e) {}
        }

        // --- ìœ„í‚¤ë°±ê³¼ ê²€ìƒ‰ ---
        async function searchWikipedia(query) {
            const cleanQuery = query.replace(/(ì´|ê°€|ì€|ëŠ”|ì„|ë¥¼)?\s*(ë­ì•¼|ì•Œë ¤ì¤˜|ì–´ë–»ê²Œ|ì™œ|ìˆì–´|ì—†ì–´|ì„¤ëª…í•´ì¤˜|ê¶ê¸ˆí•´|\?|\.|!)+/g, "").trim();
            if (cleanQuery.length < 1) return null;

            const endpoint = "https://ko.wikipedia.org/w/api.php";
            const params = new URLSearchParams({
                action: "query", format: "json", prop: "extracts",
                exintro: true, explaintext: true, redirects: 1,
                titles: cleanQuery, origin: "*"
            });

            try {
                const response = await fetch(`${endpoint}?${params}`);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId === "-1") return null;
                let content = pages[pageId].extract;
                if (content.length > 200) content = content.substring(0, 200) + "...";
                return content;
            } catch (e) { return null; }
        }

        // --- ìŒì„± ì¸ì‹ (STT) ---
        const micBtn = document.getElementById('mic-btn');
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            micBtn.onclick = () => {
                if (micBtn.classList.contains('listening')) recognition.stop();
                else recognition.start();
            };

            recognition.onstart = () => {
                micBtn.classList.add('listening');
                document.getElementById('text-input').placeholder = "ë“£ê³  ìˆì–´ìš”... ğŸ‘‚";
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
                document.getElementById('text-input').placeholder = "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('text-input').value = transcript;
                handleUserInput(transcript);
            };
        } else {
            micBtn.style.display = 'none';
        }

        // --- ë„ìŠ¨íŠ¸ ë°ì´í„° (ë²„íŠ¼ í¬í•¨) ---
        const zones = {
            'lobby': {
                name: "ë¡œë¹„ (1F)",
                basePrompt: "ë„ˆëŠ” 1ì¸µ ë¡œë¹„ ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ì•„íŠ¸ë°¸ë¦¬ëŠ” ì›ë˜ ë­í•˜ë˜ ê³³?", type: "chat", answers: ["ì›ë˜ ëŒì„ ìºë˜ ì±„ì„ì¥ì´ì—ˆì–´!"] },
                    { text: "ì²œì£¼í˜¸ ì„¤ëª…í•´ì¤˜", type: "chat", answers: ["1ê¸‰ìˆ˜ í˜¸ìˆ˜ì•¼. ê°€ì¬ë„ ì‚´ì•„!"] },
                    { text: "1ì „ì‹œì‹¤ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex1" }
                ]
            },
            'ex1': {
                name: "ì œ1ì „ì‹œì‹¤ (ì§€êµ¬)",
                basePrompt: "ë„ˆëŠ” 1ì „ì‹œì‹¤(ì§€êµ¬) ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ì§€êµ¬ êµ¬ì¡°", type: "ask", key: "earth_structure_detail" },
                    { text: "íŒêµ¬ì¡°ë¡ ", type: "ask", key: "plate_tectonics_detail" },
                    { text: "ğŸ‘ˆ ë¡œë¹„ë¡œ", type: "move", target: "lobby" },
                    { text: "2ì „ì‹œì‹¤ë¡œ â†—ï¸", type: "move", target: "ex2" }
                ]
            },
            'ex2': {
                name: "ì œ2ì „ì‹œì‹¤ (íƒœì–‘ê³„)",
                basePrompt: "ë„ˆëŠ” 2ì „ì‹œì‹¤(íƒœì–‘ê³„) ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "í–‰ì„± íŠ¹ì§•", type: "ask", key: "solar_system_planets" },
                    { text: "ëª©ì„±ê¹Œì§€ ê±°ë¦¬", type: "ask", key: "space_distance" },
                    { text: "ì˜†ë°©(íœ´ê²Œì‹¤) ğŸ‘‰", type: "move", target: "rest" }
                ]
            },
            'rest': {
                name: "íœ´ê²Œì‹¤ (ì›”ë©´ì°¨)",
                basePrompt: "ë„ˆëŠ” íœ´ê²Œì‹¤ ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ì›”ë©´ì°¨ ë°”í€´ ë¹„ë°€", type: "ask", key: "lunar_rover" },
                    { text: "3ì „ì‹œì‹¤ë¡œ ğŸ‘‰", type: "move", target: "ex3" }
                ]
            },
            'ex3': {
                name: "ì œ3ì „ì‹œì‹¤ (ìš°ì£¼)",
                basePrompt: "ë„ˆëŠ” 3ì „ì‹œì‹¤ ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ë³„ì˜ íƒ„ìƒ", type: "ask", key: "star_life_color" },
                    { text: "ì²˜ìŒìœ¼ë¡œ ğŸ ", type: "move", target: "lobby" }
                ]
            }
        };

        let currentZoneId = 'lobby';
        const hudContainer = document.getElementById('hud-container');
        const zoneBadge = document.getElementById('zone-badge');

        function addMessage(text, type) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}`;
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            bubble.innerHTML = formatted;
            hudContainer.appendChild(bubble);
            hudContainer.scrollTop = hudContainer.scrollHeight;
        }

        window.setZone = (zoneId) => {
            currentZoneId = zoneId;
            const config = zones[zoneId];
            zoneBadge.innerText = `ğŸ“ ${config.name}`;
            addMessage(`${config.name}ì— ë„ì°©í–ˆì–´!`, 'ai');
            speak(`${config.name}ì— ë„ì°©í–ˆì–´!`);
            
            // â˜… [ë³µêµ¬] ë²„íŠ¼ ë Œë”ë§ ë¡œì§
            renderButtons(config.buttons);
            logDebug("ZONE", config.name);
        };

        function renderButtons(buttons) {
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            // ë²„íŠ¼ì´ ì ìœ¼ë©´ ê°€ìš´ë° ì •ë ¬, ë§ìœ¼ë©´ ì™¼ìª½ ì •ë ¬
            if(buttons.length < 3) container.style.justifyContent = 'center';
            else container.style.justifyContent = 'flex-start';

            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.innerText = btn.text;
                b.className = `choice-btn ${btn.type === 'move' ? 'move' : ''}`;
                b.onclick = () => {
                    if (btn.type === 'move') setZone(btn.target);
                    else handleUserInput(btn.text, btn.key, btn.answers);
                };
                container.appendChild(b);
            });
        }

        // --- ë©”ì¸ í•¸ë“¤ëŸ¬ (Gemini + í…ìŠ¤íŠ¸) ---
        async function handleUserInput(text, dataKey = null, answers = null) {
            addMessage(text, 'user');

            if (answers) {
                const ans = answers[Math.floor(Math.random() * answers.length)];
                setTimeout(() => { 
                    performMotion();
                    addMessage(ans, 'ai'); 
                    speak(ans); 
                }, 500);
                return;
            }

            addMessage("ì ì‹œë§Œ... í•˜ë£¨ê°€ ì°¾ì•„ë³¼ê²Œ! ğŸ”", 'ai'); 
            
            let contextData = "";
            let contextSource = "";
            let foundItem = null;

            if (dataKey) foundItem = exhibitionData.find(d => d.id === dataKey);
            else foundItem = exhibitionData.find(d => text.includes(d.title.split('(')[0].trim()));

            if (foundItem) {
                contextSource = "ê³¼í•™ê´€ ì „ì‹œë¬¼ ì •ë³´";
                contextData = `[ì „ì‹œë¬¼ ì •ë³´] ì œëª©:${foundItem.title}, ë‚´ìš©:${foundItem.description.basic}`;
            } else {
                const wikiResult = await searchWikipedia(text);
                if (wikiResult) {
                    contextSource = "ìœ„í‚¤ë°±ê³¼";
                    contextData = `[ìœ„í‚¤ë°±ê³¼]: ${wikiResult}`;
                }
            }

            // â˜… [ì‹¬í”Œ í”„ë¡¬í”„íŠ¸] ê°ì • ë¹¼ê³ , í…ìŠ¤íŠ¸ë§Œ ìš”ì²­
            const prompt = `
                ${zones[currentZoneId].basePrompt}
                [ì§ˆë¬¸]: "${text}"
                ${contextData ? `[ì°¸ê³  ìë£Œ(${contextSource})]: ${contextData}` : "[ì°¸ê³  ìë£Œ ì—†ìŒ]"}
                
                â˜…ì§€ì¹¨â˜…
                1. ë„ˆëŠ” í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì˜ AI ë„ìŠ¨íŠ¸ 'í•˜ë£¨'ì•¼. 
                2. ê·¸ëƒ¥ ìì—°ìŠ¤ëŸ¬ìš´ ë°˜ë§(3ë¬¸ì¥ ì´ë‚´)ë¡œ ë‹µë³€í•´. (JSON ê¸ˆì§€)
                3. ì²œë¬¸/ê³¼í•™ ì§ˆë¬¸ì´ ì•„ë‹ˆë©´ "ê·¸ê±´ ë‚´ê°€ ëŒ€ë‹µí•˜ê¸° ê³¤ë€í•´."ë¼ê³  ê±°ì ˆí•´.
            `;

            try {
                const replyText = await callGeminiAPI(text, prompt);
                
                // ê°ì • ë¡œì§ ì‚­ì œë¨ -> ë¬´ì¡°ê±´ ê¸°ë³¸ ë™ì‘
                performMotion(); 
                addMessage(replyText, 'ai');
                speak(replyText);

            } catch (err) {
                console.error(err);
                addMessage("ì˜¤ë¥˜ê°€ ë‚¬ì–´ ã… ã… ", 'ai');
            }
        }

        async function callGeminiAPI(text, systemPrompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, systemPrompt: systemPrompt })
                });
                const data = await response.json();
                if (data.error) return "API ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.";
                return data.reply;
            } catch (err) {
                return "ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì¤˜.";
            }
        }

        // --- â˜… [NEW] ë¶€ë“œëŸ¬ìš´ ì… ëª¨ì–‘ (Sine Wave) ---
        function speak(text) {
            window.speechSynthesis.cancel(); 

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.pitch = 1.2; 
            utterance.rate = 1.1; 

            // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ ì·¨ì†Œ
            if (mouthAnimId) {
                cancelAnimationFrame(mouthAnimId);
                mouthAnimId = null;
            }

            utterance.onstart = () => {
                logDebug("TTS", "ë§í•˜ê¸° ì‹œì‘");
                const startTime = Date.now();

                // ë¶€ë“œëŸ¬ìš´ ì… ëª¨ì–‘ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
                function animateMouth() {
                    if (!live2dModel) return;
                    
                    const now = Date.now();
                    // Math.sinì„ ì´ìš©í•´ 0~1 ì‚¬ì´ë¥¼ ë¶€ë“œëŸ½ê²Œ ì˜¤ê°€ëŠ” íŒŒë™ ìƒì„±
                    // ì†ë„ ì¡°ì ˆ: now / 150 (ìˆ«ìê°€ í´ìˆ˜ë¡ ëŠë ¤ì§)
                    const value = (Math.sin(now / 150) + 1) / 2; 
                    
                    // ì… ë²Œë¦¼ ì •ë„ ì¡°ì ˆ (0.2 ~ 0.8 ì‚¬ì´ë¡œ ì›€ì§ì„)
                    const mouthOpen = value * 0.6 + 0.2; 

                    try {
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', mouthOpen);
                        // ParamMouthOpen ë„ ê°™ì´ ì¤˜ì„œ í˜¸í™˜ì„± í™•ë³´
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpen', mouthOpen);
                    } catch(e) {}

                    mouthAnimId = requestAnimationFrame(animateMouth);
                }
                
                animateMouth(); // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            };

            utterance.onend = () => {
                logDebug("TTS", "ë§í•˜ê¸° ë");
                if (mouthAnimId) {
                    cancelAnimationFrame(mouthAnimId);
                    mouthAnimId = null;
                }
                // ì… í™•ì‹¤í•˜ê²Œ ë‹«ê¸°
                if (live2dModel) {
                    try { 
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0); 
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpen', 0); 
                    } catch(e){}
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        sendBtn.onclick = () => { if(textInput.value){ handleUserInput(textInput.value); textInput.value=''; }};
        textInput.onkeypress = (e) => { if(e.key==='Enter') sendBtn.click(); };

        window.onload = () => setZone('lobby');
    </script>
</body>
</html>
