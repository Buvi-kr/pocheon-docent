<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    <style>
        /* --- ê¸°ë³¸ ì„¤ì • --- */
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background: #000; 
            color: white; 
            font-family: 'Pretendard', sans-serif; 
            overflow: hidden; 
        }

        /* ë°°ê²½ íš¨ê³¼ */
        .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a237e 0%, #000000 80%); }
        .stars { position: absolute; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.4; z-index: -1; }

        /* 1. ìƒë‹¨ í—¤ë” */
        .header-area { 
            flex: 0 0 auto; 
            padding: 15px; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }
        .character-img { 
            width: 45px; height: 45px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; 
            border: 2px solid #4fc3f7; 
        }
        .header-text h1 { margin: 0; font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px #4fc3f7; }
        .header-text p { margin: 0; font-size: 0.8rem; color: #ccc; }

        /* 2. ì±„íŒ… ì˜ì—­ */
        .chat-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; 
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message { padding: 12px 16px; border-radius: 18px; max-width: 80%; line-height: 1.5; font-size: 0.95rem; word-break: break-word; animation: popIn 0.3s; }
        .user-msg { background: #3949ab; align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .ai-msg { background: rgba(255,255,255,0.15); align-self: flex-start; border-bottom-left-radius: 4px; color: #e3f2fd; border: 1px solid rgba(255,255,255,0.1); }
        .error-msg { background: #d32f2f; color: white; align-self: center; font-size: 0.85rem; border-radius: 10px; }
        
        .system-msg { text-align: center; color: #888; font-size: 0.8rem; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; align-self: center; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* 3. í•˜ë‹¨ ì…ë ¥ì°½ */
        .control-area { 
            flex: 0 0 auto; 
            padding: 10px 15px;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            background: #121212; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border-top: 1px solid #333;
            z-index: 20;
        }

        .input-box {
            flex: 1;
            background: #2c2c2c;
            border: 1px solid #444;
            border-radius: 25px;
            padding: 12px 15px;
            color: white;
            font-size: 1rem;
            outline: none;
            font-family: 'Pretendard', sans-serif;
        }
        .input-box::placeholder { color: #888; }

        .icon-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        
        #mic-btn { background: #f44336; }
        #mic-btn.listening { background: #4caf50; animation: pulse 1.5s infinite; }
        #send-btn { background: #3949ab; }
        #send-btn:active { transform: scale(0.9); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }

    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>

    <div class="header-area">
        <div class="character-img" id="char-icon">ğŸ¤–</div>
        <div class="header-text">
            <h1 id="exhibit-name">ë„ìŠ¨íŠ¸ ì—°ê²° ì¤‘...</h1>
            <p id="status-text">ëŒ€ê¸° ì¤‘</p>
        </div>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="system-msg">ë§ˆì´í¬ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
    </div>

    <div class="control-area">
        <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
        <input type="text" class="input-box" id="text-input" placeholder="ì§ˆë¬¸í•˜ê¸°..." autocomplete="off">
        <button class="icon-btn" id="send-btn">â¤</button>
    </div>

    <script>
        // --- ì „ì‹œë¬¼ ë°ì´í„° ---
        const exhibits = {
            'jupiter': { name: 'ëª©ì„± (Jupiter)', icon: 'ğŸª', prompt: 'ë„ˆëŠ” íƒœì–‘ê³„ì˜ ì™•, ëª©ì„±ì´ë‹¤. ì•„ì£¼ ê±°ëŒ€í•˜ê³  ìœ„ì—„ ìˆì§€ë§Œ ì•„ì´ë“¤ì—ê²Œ ì¹œì ˆí•´. ë„ˆì˜ ëŒ€ì ì ê³¼ ìœ„ì„±ë“¤ì— ëŒ€í•´ ìë‘í•´ì¤˜.' },
            'apollo': { name: 'ì•„í´ë¡œ 11í˜¸', icon: 'ğŸš€', prompt: 'ë„ˆëŠ” ì¸ë¥˜ ìµœì´ˆë¡œ ë‹¬ì— ì°©ë¥™í•œ ì•„í´ë¡œ 11í˜¸ì•¼. ëª¨í—˜ì‹¬ì´ ê°•í•˜ê³  ìš©ê°í•œ ë§íˆ¬ë¥¼ ì¨. ë‹¬ ì°©ë¥™ì˜ ìˆœê°„ì„ ìƒìƒí•˜ê²Œ ë§í•´ì¤˜.' },
            'default': { name: 'ì•ˆë‚´ ë°ìŠ¤í¬', icon: 'ğŸ’', prompt: 'ë„ˆëŠ” ì²œë¬¸ê³¼í•™ê´€ì˜ ë§ˆìŠ¤ì½”íŠ¸ í¬ìš°ë¦¬ì•¼. ê´€ëŒê°ì—ê²Œ ì¹œì ˆí•˜ê²Œ ì¸ì‚¬í•˜ê³  ë„ì™€ì¤˜.' }
        };

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const currentData = exhibits[id] || exhibits['default'];

        document.getElementById('exhibit-name').innerText = currentData.name;
        document.getElementById('char-icon').innerText = currentData.icon;

        // --- UI í•¨ìˆ˜ ---
        const chatBox = document.getElementById('chat-box');
        const statusText = document.getElementById('status-text');

        function addMessage(text, type) {
            const div = document.createElement('div');
            // ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì¶”ê°€
            if (type === 'error') {
                div.className = 'message error-msg';
            } else {
                div.className = `message ${type === 'user' ? 'user-msg' : 'ai-msg'}`;
            }
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function handleUserInput(text) {
            if (!text.trim()) return;

            addMessage(text, 'user');
            statusText.innerText = "ìƒê°í•˜ëŠ” ì¤‘...";

            const reply = await callGeminiAPI(text);
            
            // undefinedê°€ ì•„ë‹ˆë¼ ì§„ì§œ ì—ëŸ¬ ë‚´ìš©ì„ ë³´ì—¬ì¤Œ
            if (reply.startsWith("ì˜¤ë¥˜")) {
                statusText.innerText = "ì˜¤ë¥˜ ë°œìƒ";
                addMessage(reply, 'error');
            } else {
                statusText.innerText = "ë‹µë³€ ì¤‘...";
                addMessage(reply, 'ai');
                speak(reply);
            }
        }

        // --- ì…ë ¥ ì²˜ë¦¬ ---
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');

        function sendText() {
            const text = textInput.value;
            if (text) {
                handleUserInput(text);
                textInput.value = ''; 
            }
        }

        sendBtn.addEventListener('click', sendText);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendText();
        });

        const micBtn = document.getElementById('mic-btn');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if(SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                window.speechSynthesis.cancel();
                micBtn.classList.add('listening');
                statusText.innerText = "ë“£ê³  ìˆì–´ìš”...";
                recognition.start();
            });

            recognition.onresult = (event) => {
                const voiceText = event.results[0][0].transcript;
                micBtn.classList.remove('listening');
                handleUserInput(voiceText);
            };

            recognition.onerror = () => {
                micBtn.classList.remove('listening');
                statusText.innerText = "ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.";
            };
            
            recognition.onspeechend = () => {
                micBtn.classList.remove('listening');
                statusText.innerText = "ì²˜ë¦¬ ì¤‘...";
            }
        } else {
            micBtn.style.display = 'none';
            addMessage("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", 'ai');
        }

        // --- â˜… ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì •ëœ ë¶€ë¶„ (ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”) â˜… ---
        async function callGeminiAPI(text) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text,
                        systemPrompt: currentData.prompt 
                    })
                });

                // ì„œë²„ê°€ 200(ì„±ê³µ)ì´ ì•„ë‹ˆë©´ ì—ëŸ¬ë¡œ ê°„ì£¼
                if (!response.ok) {
                    const errData = await response.json();
                    return "ì˜¤ë¥˜: " + (errData.error || "ì„œë²„ ë¬¸ì œ ë°œìƒ");
                }

                const data = await response.json();
                
                // ë‹µë³€ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
                if (!data.reply) {
                    return "ì˜¤ë¥˜: AIê°€ ì‘ë‹µí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                }

                return data.reply;

            } catch (err) {
                console.error(err);
                return "ì˜¤ë¥˜: ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”)";
            }
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
            utterance.onend = () => { statusText.innerText = "ëŒ€ê¸° ì¤‘"; };
        }
    </script>
</body>
</html>
