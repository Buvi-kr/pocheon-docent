<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

    <style>
        /* --- 1. ì „ì²´ ë ˆì´ì•„ì›ƒ & ë°°ê²½ --- */
        body { margin: 0; padding: 0; background: #0b0c15; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; height: 100vh; height: 100dvh; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at bottom, #1a237e 0%, #000000 80%); }
        .stars { position: fixed; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.5; z-index: 0; pointer-events: none; }

        /* --- 2. Live2D ìº”ë²„ìŠ¤ --- */
        #live2d-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1; 
            display: block;
        }

        /* --- 3. ì™¼ìª½ ìƒë‹¨ HUD (ëŒ€í™” ë¡œê·¸) --- */
        .hud-area {
            position: fixed;
            top: 20px;
            left: 20px;
            height: 35vh; /* í™”ë©´ ìƒë‹¨ 35%ë§Œ ì‚¬ìš© (ì–¼êµ´ ê°€ë¦¬ì§€ ì•Šê²Œ ì¡°ì ˆ) */
            width: calc(100% - 40px);
            max-width: 350px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            pointer-events: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 100%);
        }
        .hud-area::-webkit-scrollbar { display: none; }

        .zone-badge {
            align-self: flex-start;
            background: rgba(79, 195, 247, 0.2);
            border: 1px solid #4fc3f7;
            color: #4fc3f7;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.3);
            flex-shrink: 0; 
        }

        .chat-bubble {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            color: #fff;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.4s ease-out;
            border-left: 3px solid transparent;
            flex-shrink: 0; 
        }
        .chat-bubble.user { border-left-color: #ff9800; align-self: flex-start; background: rgba(0, 0, 0, 0.4); color: #ffd180; }
        .chat-bubble.ai { border-left-color: #4fc3f7; align-self: flex-start; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        /* --- 4. í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ --- */
        .bottom-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
        }

        .choice-scroll-area {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 15px;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .choice-scroll-area::-webkit-scrollbar { display: none; }

        .choice-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.2s;
        }
        .choice-btn:active { transform: scale(0.95); background: #4fc3f7; color: black; border-color: #4fc3f7; }
        .choice-btn.move { border-color: #ff9800; color: #ff9800; background: rgba(255, 152, 0, 0.1); }

        .input-bar {
            width: calc(100% - 30px);
            max-width: 600px;
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .input-box {
            flex: 1;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #555;
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 1rem;
            outline: none;
            backdrop-filter: blur(5px);
        }
        .icon-btn {
            width: 48px; height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        #mic-btn { background: rgba(244, 67, 54, 0.8); }
        #mic-btn.listening { background: #4caf50; box-shadow: 0 0 15px #4caf50; animation: pulse 1.5s infinite; }
        #send-btn { background: rgba(63, 81, 181, 0.8); }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>
    <canvas id="live2d-canvas"></canvas>

    <div class="hud-area" id="hud-container">
        <div class="zone-badge" id="zone-badge">ğŸ›ï¸ ë¡œë¹„</div>
        <div class="chat-bubble ai">
            ì•ˆë…•! ë‚˜ëŠ” íˆìš”ë¦¬ì•¼! ğŸ°<br>
            í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì— ì˜¨ ê±¸ í™˜ì˜í•´.<br>
            ê¶ê¸ˆí•œ ê²Œ ìˆìœ¼ë©´ ë­ë“  ë¬¼ì–´ë´!
        </div>
    </div>

    <div class="bottom-container">
        <div class="choice-scroll-area" id="choice-container"></div>
        <div class="input-bar">
            <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
            <input type="text" class="input-box" id="text-input" placeholder="ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”..." autocomplete="off">
            <button class="icon-btn" id="send-btn">â¤</button>
        </div>
    </div>

    <script type="module">
        import { exhibitionData } from './knowledge.js';

        // --- Live2D ì„¤ì • ---
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/Live2D/CubismWebSamples@develop/Samples/Resources/Hiyori/Hiyori.model3.json';
        let live2dApp = null;
        let live2dModel = null;

        async function initLive2D() {
            try {
                live2dApp = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    autoStart: true,
                    resizeTo: window,
                    backgroundAlpha: 0 
                });

                if(!window.PIXI.live2d) throw new Error("Plugin not loaded");
                live2dModel = await PIXI.live2d.Live2DModel.from(MODEL_URL);

                resizeModel();

                live2dApp.stage.addChild(live2dModel);
                live2dModel.interactive = true;
                live2dModel.on('pointertap', () => {
                    live2dModel.motion('TapBody');
                    addMessage("í—¤í—¤, ë°˜ê°€ì›Œ!", 'ai'); 
                    speak("í—¤í—¤, ë°˜ê°€ì›Œ!");
                });

                console.log("Live2D ì´ˆê¸°í™” ì™„ë£Œ");
            } catch (e) { console.error("Live2D ë¡œë“œ ì‹¤íŒ¨:", e); }
        }

        // [í•µì‹¬ ìˆ˜ì •] ëª¸í†µ ì˜ë¼ë‚´ê¸° (ì–¼êµ´ ì§‘ì¤‘ ëª¨ë“œ)
        function resizeModel() {
            if (!live2dModel) return;

            const isMobile = window.innerWidth < 600;

            // 1. ê¸°ì¤€ì : ë¨¸ë¦¬ ê¼­ëŒ€ê¸°(0.0) ê³ ì •
            live2dModel.anchor.set(0.5, 0);

            // 2. ê°€ë¡œ: ì¤‘ì•™
            live2dModel.x = window.innerWidth / 2;

            // 3. ì„¸ë¡œ: í™”ë©´ ìƒë‹¨ (ì´ë§ˆê°€ í™”ë©´ ìœ„ìª½ì— ë‹¿ê²Œ)
            // 0.05 = í™”ë©´ ë§¨ ìœ„ì—ì„œ 5% ì •ë„ ë‚´ë ¤ì˜´ (ë„ˆë¬´ ë”± ë¶™ì§€ ì•Šê²Œ)
            live2dModel.y = window.innerHeight * 0.05;

            // 4. í¬ê¸°: ì—„ì²­ë‚˜ê²Œ í‚¤ì›€ (Zoom-in íš¨ê³¼)
            // ëª¨ë°”ì¼ì€ 0.85ë°°, PCëŠ” 0.55ë°°
            // ì´ë ‡ê²Œ í•˜ë©´ ëª¸í†µì€ í™”ë©´ ê¸¸ì´ë¥¼ ë„˜ì–´ê°€ì„œ ìë™ìœ¼ë¡œ ì•ˆ ë³´ì´ê²Œ ë¨
            const scale = isMobile ? 0.85 : 0.55;
            live2dModel.scale.set(scale);
        }

        window.addEventListener('resize', resizeModel);
        initLive2D();

        // --- ë„ìŠ¨íŠ¸ ë¡œì§ ---
        const zones = {
            'lobby': {
                name: "ë¡œë¹„ (1F)",
                basePrompt: "ë„ˆëŠ” 1ì¸µ ë¡œë¹„ ë„ìŠ¨íŠ¸ì•¼. ì•„íŠ¸ë°¸ë¦¬ ì—­ì‚¬ì™€ ê³¼í•™ê´€ ì „ì²´ êµ¬ì¡°ë¥¼ ì„¤ëª…í•´ì¤˜.",
                buttons: [
                    { text: "ì•„íŠ¸ë°¸ë¦¬ëŠ” ì›ë˜ ë­í•˜ë˜ ê³³?", type: "chat", answers: ["ì›ë˜ ëŒì„ ìºë˜ ì±„ì„ì¥ì´ì—ˆì–´!"] },
                    { text: "ì²œì£¼í˜¸ ì„¤ëª…í•´ì¤˜", type: "chat", answers: ["1ê¸‰ìˆ˜ í˜¸ìˆ˜ì•¼. ê°€ì¬ë„ ì‚´ì•„!"] },
                    { text: "1ì „ì‹œì‹¤ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex1" }
                ]
            },
            'ex1': {
                name: "ì œ1ì „ì‹œì‹¤ (ì§€êµ¬)",
                basePrompt: "ë„ˆëŠ” 1ì „ì‹œì‹¤(ì§€êµ¬) ë„ìŠ¨íŠ¸ì•¼. ì§€êµ¬ ë‚´ë¶€ì™€ íŒêµ¬ì¡°ë¡ ì„ ì„¤ëª…í•´ì¤˜.",
                buttons: [
                    { text: "ì§€êµ¬ êµ¬ì¡°", type: "ask", key: "earth_structure_detail" },
                    { text: "íŒêµ¬ì¡°ë¡ ", type: "ask", key: "plate_tectonics_detail" },
                    { text: "ğŸ‘ˆ ë¡œë¹„ë¡œ", type: "move", target: "lobby" },
                    { text: "2ì „ì‹œì‹¤ë¡œ â†—ï¸", type: "move", target: "ex2" }
                ]
            },
            'ex2': {
                name: "ì œ2ì „ì‹œì‹¤ (íƒœì–‘ê³„)",
                basePrompt: "ë„ˆëŠ” 2ì „ì‹œì‹¤(íƒœì–‘ê³„) ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "í–‰ì„± íŠ¹ì§•", type: "ask", key: "solar_system_planets" },
                    { text: "ëª©ì„±ê¹Œì§€ ê±°ë¦¬", type: "ask", key: "space_distance" },
                    { text: "ì˜†ë°©(íœ´ê²Œì‹¤) ğŸ‘‰", type: "move", target: "rest" }
                ]
            },
            'rest': {
                name: "íœ´ê²Œì‹¤ (ì›”ë©´ì°¨)",
                basePrompt: "ë„ˆëŠ” íœ´ê²Œì‹¤ ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ì›”ë©´ì°¨ ë°”í€´ ë¹„ë°€", type: "ask", key: "lunar_rover" },
                    { text: "3ì „ì‹œì‹¤ë¡œ ğŸ‘‰", type: "move", target: "ex3" }
                ]
            },
            'ex3': {
                name: "ì œ3ì „ì‹œì‹¤ (ìš°ì£¼)",
                basePrompt: "ë„ˆëŠ” 3ì „ì‹œì‹¤ ë„ìŠ¨íŠ¸ì•¼.",
                buttons: [
                    { text: "ë³„ì˜ íƒ„ìƒ", type: "ask", key: "star_life_color" },
                    { text: "ì²˜ìŒìœ¼ë¡œ ğŸ ", type: "move", target: "lobby" }
                ]
            }
        };

        let currentZoneId = 'lobby';
        const hudContainer = document.getElementById('hud-container');
        const zoneBadge = document.getElementById('zone-badge');

        function addMessage(text, type) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}`;
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            bubble.innerHTML = formatted;
            hudContainer.appendChild(bubble);
            hudContainer.scrollTop = hudContainer.scrollHeight;
        }

        window.setZone = (zoneId) => {
            currentZoneId = zoneId;
            const config = zones[zoneId];
            zoneBadge.innerText = `ğŸ“ ${config.name}`;
            addMessage(`${config.name}ì— ë„ì°©í–ˆì–´!`, 'ai');
            speak(`${config.name}ì— ë„ì°©í–ˆì–´!`);
            renderButtons(config.buttons);
        };

        function renderButtons(buttons) {
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            if(buttons.length < 3) container.style.justifyContent = 'center';
            else container.style.justifyContent = 'flex-start';

            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.innerText = btn.text;
                b.className = `choice-btn ${btn.type === 'move' ? 'move' : ''}`;
                b.onclick = () => {
                    if (btn.type === 'move') setZone(btn.target);
                    else handleUserInput(btn.text, btn.key, btn.answers);
                };
                container.appendChild(b);
            });
        }

        async function handleUserInput(text, dataKey = null, answers = null) {
            addMessage(text, 'user');

            if (answers) {
                const ans = answers[Math.floor(Math.random() * answers.length)];
                setTimeout(() => { 
                    addMessage(ans, 'ai'); 
                    speak(ans); 
                    if(live2dModel) try { live2dModel.motion('TapBody'); } catch(e){}
                }, 500);
                return;
            }

            addMessage("ì ì‹œë§Œ... ìƒê° ì¢€ í•´ë³¼ê²Œ!", 'ai'); 
            
            let contextData = "";
            if (dataKey) {
                const item = exhibitionData.find(d => d.id === dataKey);
                if (item) contextData = `[ì°¸ê³  ì •ë³´] ${item.description.basic}`;
            }

            const prompt = `
                ${zones[currentZoneId].basePrompt}
                ${contextData}
                (ë‹µë³€ ê·œì¹™: íˆìš”ë¦¬ì²˜ëŸ¼ ê·€ì—½ê³  ì¹œê·¼í•œ ë°˜ë§ë¡œ, 3ë¬¸ì¥ ì´ë‚´ë¡œ ì§§ê²Œ í•µì‹¬ë§Œ ë§í•´ì¤˜.)
            `;

            const reply = await callGeminiAPI(text, prompt);
            
            addMessage(reply, 'ai');
            speak(reply);
            if(live2dModel) try { live2dModel.motion('TapBody'); } catch(e){}
        }

        async function callGeminiAPI(text, systemPrompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, systemPrompt: systemPrompt })
                });
                const data = await response.json();
                if (data.error) {
                    console.error("API Error:", data.error);
                    return "ì•—, ë¨¸ë¦¬ê°€ ì¢€ ì•„íŒŒ... ë‹¤ì‹œ ë¬¼ì–´ë´ì¤„ë˜?";
                }
                return data.reply || "ëŒ€ë‹µì„ ëª» ì°¾ê² ì–´ ã… ã… ";
            } catch (err) {
                console.error("Network Error:", err);
                return "ì¸í„°ë„· ì—°ê²°ì´ ì¢€ ë¶ˆì•ˆí•œ ê²ƒ ê°™ì•„!";
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            window.speechSynthesis.speak(utterance);
            
            let interval = setInterval(() => {
                if (live2dModel) {
                    try { live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.random()); } catch(e){}
                }
            }, 100);

            utterance.onend = () => {
                clearInterval(interval);
                if (live2dModel) try { live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0); } catch(e){}
            };
        }

        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        sendBtn.onclick = () => { if(textInput.value){ handleUserInput(textInput.value); textInput.value=''; }};
        textInput.onkeypress = (e) => { if(e.key==='Enter') sendBtn.click(); };

        window.onload = () => setZone('lobby');
    </script>
</body>
</html>
