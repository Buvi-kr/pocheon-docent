<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    <style>
        /* CSSëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ */
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; background: #0b0c15; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a237e 0%, #000000 90%); }
        .stars { position: absolute; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.4; z-index: -1; }
        
        .header-area { flex: 0 0 auto; padding: 15px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; z-index: 10; }
        .character-img { width: 50px; height: 50px; background: white; border-radius: 50%; border: 2px solid #4fc3f7; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: 0.3s; }
        .character-img.talking { border-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        .header-text h1 { margin: 0; font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px #4fc3f7; }
        .header-text p { margin: 0; font-size: 0.8rem; color: #4fc3f7; font-weight: bold; }

        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; word-break: break-word; animation: popIn 0.3s; }
        .user-msg { background: #3949ab; align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .ai-msg { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; color: #e3f2fd; border: 1px solid rgba(255,255,255,0.1); }
        .system-msg { text-align: center; color: #aaa; font-size: 0.85rem; margin: 10px 0; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px; align-self: center; border: 1px solid #555; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .choice-area { flex: 0 0 auto; display: flex; gap: 10px; padding: 10px 15px; overflow-x: auto; background: rgba(0,0,0,0.3); white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .choice-area::-webkit-scrollbar { display: none; }
        .choice-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid #4fc3f7; color: #4fc3f7; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .choice-btn:active { background: #4fc3f7; color: black; }
        .choice-btn.move-btn { border-color: #ff9800; color: #ff9800; }
        .choice-btn.move-btn:active { background: #ff9800; color: white; }

        .control-area { flex: 0 0 auto; padding: 10px 15px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: #121212; display: flex; align-items: center; gap: 10px; border-top: 1px solid #333; z-index: 20; }
        .input-box { flex: 1; background: #2c2c2c; border: 1px solid #444; border-radius: 25px; padding: 12px 15px; color: white; font-size: 1rem; outline: none; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #mic-btn { background: #f44336; }
        #mic-btn.listening { background: #4caf50; animation: pulse 1.5s infinite; }
        #send-btn { background: #3949ab; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>

    <div class="header-area">
        <div class="character-img" id="char-icon">ğŸ°</div>
        <div class="header-text">
            <h1 id="zone-name">ë¡œë¹„</h1>
            <p id="status-text">ê°™ì´ ë‘˜ëŸ¬ë³´ì!</p>
        </div>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="message ai-msg">
            ì•ˆë…•! ë˜ë¹„, ë„ê¸°, ìºí‹°ì•¼! ğŸ°ğŸ¶ğŸ±<br>
            í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì— ì˜¨ ê±¸ í™˜ì˜í•´.<br>
            ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ íˆ¬ì–´ë¥¼ ì‹œì‘í•´ë³¼ê¹Œ?
        </div>
    </div>

    <div class="choice-area" id="choice-container"></div>

    <div class="control-area">
        <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
        <input type="text" class="input-box" id="text-input" placeholder="ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´..." autocomplete="off">
        <button class="icon-btn" id="send-btn">â¤</button>
    </div>

    <script type="module">
        import { exhibitionData } from './knowledge.js';

        // â˜… [í•µì‹¬ 1] ë¡œë¹„ í”„ë¡¬í”„íŠ¸ ëŒ€í­ ê°•í™” (ëª¨ë“  ì¸µ ì •ë³´ ì£¼ì…)
        // â˜… [í•µì‹¬ 2] ë‹µë³€(answers)ì„ ë°°ì—´ë¡œ ë§Œë“¤ì–´ì„œ ëœë¤ ì¶œë ¥
        const zones = {
            'lobby': {
                name: "ë¡œë¹„ (1F)",
                icon: "ğŸ›ï¸",
                // ë¡œë¹„ëŠ” ì „ì²´ë¥¼ ë‹¤ ì•Œì•„ì•¼ í•˜ë¯€ë¡œ 'ì „ì²´ ì¸µë³„ ìš”ì•½'ì„ í”„ë¡¬í”„íŠ¸ì— ë„£ìŠµë‹ˆë‹¤.
                basePrompt: `
                    ë„ˆëŠ” ì²œë¬¸ê³¼í•™ê´€ì˜ ì–¼êµ´ '1ì¸µ ë¡œë¹„' ë„ìŠ¨íŠ¸ì•¼.
                    [í•„ìˆ˜ ìˆ™ì§€ - ê³¼í•™ê´€ ì „ì²´ êµ¬ì¡°]
                    1. 1ì¸µ: ë¡œë¹„, ì œ1ì „ì‹œì‹¤(ì§€êµ¬ íƒ„ìƒê³¼ êµ¬ì¡°, íŒêµ¬ì¡°ë¡ ).
                    2. 2ì¸µ: ì œ2ì „ì‹œì‹¤(íƒœì–‘ê³„, ìš´ì„), íœ´ê²Œì‹¤(ì›”ë©´ì°¨, ì§€êµ¬ì˜¨), ì œ3ì „ì‹œì‹¤(ë³„, ì²œìƒì—´ì°¨ë¶„ì•¼ì§€ë„).
                    3. 3ì¸µ/ì˜¥ìƒ: ì²œì²´íˆ¬ì˜ì‹¤(4Dì˜ìƒ), ì²œì²´ê´€ì¸¡ì‹¤(ë§ì›ê²½).
                    4. ì—­ì‚¬: ì´ê³³ì€ ì›ë˜ 1960~90ë…„ëŒ€ í™”ê°•ì•” ì±„ì„ì¥ì´ì—ˆìŒ. 2009ë…„ ë¬¸í™”ì˜ˆìˆ  ê³µê°„ìœ¼ë¡œ ì¬íƒ„ìƒ. (ì†¡ìœ ê´€ X)
                    5. ì²œì£¼í˜¸: ì±„ì„ í›„ ë‚¨ì€ ì›…ë©ì´ì— ë¬¼ì´ ê³ ì—¬ ìƒê¸´ 1ê¸‰ìˆ˜ í˜¸ìˆ˜.
                `,
                buttons: [
                    { 
                        text: "ì•„íŠ¸ë°¸ë¦¬ëŠ” ì›ë˜ ë­í•˜ë˜ ê³³?", 
                        type: "chat", 
                        // ë‹µë³€ì„ 5ê°œ ì¤€ë¹„ (ëœë¤ ì¶œë ¥)
                        answers: [
                            "ì—¬ê¸°ëŠ” ì›ë˜ ëŒì„ ìºë˜ ì±„ì„ì¥ì´ì—ˆì–´! â›ï¸ 1960ë…„ëŒ€ë¶€í„° í™”ê°•ì•”ì„ ìºë‹¤ê°€ 2009ë…„ì— ë©‹ì§„ ê³µì›ìœ¼ë¡œ ë³€ì‹ í–ˆì§€.",
                            "ë¯¿ê¸°ì§€ ì•Šê² ì§€ë§Œ, ì˜›ë‚ ì—” ì—¬ê¸°ê°€ ì‹œë„ëŸ¬ìš´ ì±„ì„ì¥ì´ì—ˆëŒ€. ë²„ë ¤ì§„ ê³³ì„ ì´ë ‡ê²Œ ì•„ë¦„ë‹¤ìš´ ì˜ˆìˆ  ê³µê°„ìœ¼ë¡œ ë‹¤ì‹œ ì‚´ë ¤ë‚¸ ê±°ì•¼! âœ¨",
                            "ëŒì„ ìºë˜ ì›…ë©ì´ì— ë¬¼ì´ ê³ ì—¬ì„œ ì²œì£¼í˜¸ê°€ ë˜ê³ , ì ˆë²½ì€ ë©‹ì§„ í’ê²½ì´ ë˜ì—ˆì–´. ìì—°ê³¼ ì‚¬ëŒì´ ê°™ì´ ë§Œë“  ê¸°ì ì´ì§€! ğŸŒ¿",
                            "ì›ë˜ëŠ” í™”ê°•ì•”ì„ ìƒì‚°í•˜ë˜ ê³³ì´ì•¼. ì±„ì„ ì‘ì—…ì´ ëë‚˜ê³  ë°©ì¹˜ë˜ì–´ ìˆì—ˆëŠ”ë°, í¬ì²œì‹œê°€ ë©‹ì§€ê²Œ ê¾¸ë©°ì„œ ì§€ê¸ˆì˜ ì•„íŠ¸ë°¸ë¦¬ê°€ ëì–´.",
                            "ê³¼ê±°ì—” ëŒì„ ìºëŠ” ì†Œë¦¬ë¡œ ê°€ë“ ì°¼ì§€ë§Œ, ì§€ê¸ˆì€ ì›ƒìŒì†Œë¦¬ê°€ ê°€ë“í•œ ì˜ˆìˆ  ê³µì›ì´ ë˜ì—ˆì–´. ğŸµ ì •ë§ ë©‹ì§„ ë³€ì‹ ì´ì§€?"
                        ]
                    },
                    { 
                        text: "ì²œì£¼í˜¸ëŠ” ì–´ë–»ê²Œ ìƒê²¼ì–´?", 
                        type: "chat", 
                        answers: [
                            "ì±„ì„ì¥ ì›…ë©ì´ì— ìƒ˜ë¬¼ê³¼ ë¹—ë¬¼ì´ ëª¨ì—¬ì„œ ìƒê¸´ í˜¸ìˆ˜ì•¼. ë¬¼ì´ ì—„ì²­ ë§‘ì•„ì„œ ê°€ì¬ë„ ì‚°ëŒ€! ğŸ¦",
                            "ì‚¬ëŒì´ íŒ ì›…ë©ì´ì— ìì—°ì´ ë¬¼ì„ ì±„ì›Œì¤€ ê±°ì•¼. ì—ë©”ë„ë“œë¹› ë¬¼ìƒ‰ê¹”ì´ ì •ë§ ì‹ ë¹„ë¡­ì§€ ì•Šì•„? âœ¨",
                            "ëŒì„ íŒŒë‚¸ ìë¦¬ì— ë¬¼ì´ ê³ ì—¬ì„œ ë§Œë“¤ì–´ì¡Œì–´. ìµœëŒ€ ìˆ˜ì‹¬ì´ 20më‚˜ ëœëŒ€! 1ê¸‰ìˆ˜ë¼ì„œ ë„ë¡±ë‡½ë„ ì‚´ì•„.",
                            "ê¹ì•„ì§€ë¥¸ í™”ê°•ì•” ì ˆë²½ê³¼ ì–´ìš°ëŸ¬ì§„ í˜¸ìˆ˜ì•¼. ì›ë˜ëŠ” ê·¸ëƒ¥ ì›…ë©ì´ì˜€ëŠ”ë° ì§€ê¸ˆì€ ì•„íŠ¸ë°¸ë¦¬ì˜ ë³´ë¬¼ì´ ëì–´.",
                            "í•˜ëŠ˜ì—ì„œ ë¹„ê°€ ë‚´ë¦¬ê³  ë•…ì—ì„œ ìƒ˜ì´ ì†Ÿì•„ ë§Œë“¤ì–´ì§„ ì¸ê³µ í˜¸ìˆ˜ì•¼. ë°¤ì— ë³´ë©´ ì¡°ëª… ë•Œë¬¸ì— ë” ì˜ˆë»! ğŸŒ™"
                        ]
                    },
                    { text: "1ì „ì‹œì‹¤(ìš°ì¸¡)ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex1" }
                ]
            },
            'ex1': {
                name: "ì œ1ì „ì‹œì‹¤: ì§€êµ¬ (1F)",
                icon: "ğŸŒ",
                basePrompt: `
                    ë„ˆëŠ” 1ì „ì‹œì‹¤(ì§€êµ¬) ë„ìŠ¨íŠ¸ì•¼.
                    [í•„ìˆ˜ íŒ©íŠ¸] 1.ì§€êµ¬êµ¬ì¡°(ë‚´í•µ/ì™¸í•µ/ë§¨í‹€/ì§€ê°), 2.íŒêµ¬ì¡°ë¡ , 3.ë‹¬íƒ„ìƒ(ê±°ëŒ€ì¶©ëŒì„¤).
                `,
                buttons: [
                    { text: "ì§€êµ¬ ë‚´ë¶€ëŠ” ì–´ë–»ê²Œ ìƒê²¼ì–´?", type: "ask", key: "earth_structure_detail" },
                    { text: "íŒêµ¬ì¡°ë¡ ì´ ë­ì•¼?", type: "ask", key: "plate_tectonics_detail" },
                    { text: "ë‹¬ì€ ì–´ë–»ê²Œ ìƒê²¨ë‚¬ì–´?", type: "ask", key: "earth_moon_origin" },
                    { text: "ğŸ‘ˆ ë¡œë¹„ë¡œ", type: "move", target: "lobby" },
                    { text: "2ì „ì‹œì‹¤(2F)ë¡œ ì˜¬ë¼ê°€ê¸° â†—ï¸", type: "move", target: "ex2" }
                ]
            },
            'ex2': {
                name: "ì œ2ì „ì‹œì‹¤: íƒœì–‘ê³„ (2F)",
                icon: "ğŸª",
                basePrompt: `
                    ë„ˆëŠ” 2ì „ì‹œì‹¤(íƒœì–‘ê³„) ë„ìŠ¨íŠ¸ì•¼.
                    [í•„ìˆ˜ íŒ©íŠ¸] 1.í–‰ì„±ìˆœì„œ(ìˆ˜ê¸ˆì§€í™”ëª©í† ì²œí•´), 2.ëª©ì„±(ìµœëŒ€í¬ê¸°), 3.ì „ì‹œë¬¼ìœ„ì¹˜(ê°€ìš´ë° ì§„ì—´ì¥).
                `,
                buttons: [
                    { text: "í–‰ì„± íŠ¹ì§• ì•Œë ¤ì¤˜", type: "ask", key: "solar_system_planets" },
                    { text: "ì§€êµ¬ì—ì„œ ëª©ì„±ê¹Œì§€ ì–¼ë§ˆë‚˜ ê±¸ë ¤?", type: "ask", key: "space_distance" },
                    { text: "ì´ ìš´ì„ë“¤ ì§„ì§œì•¼?", type: "ask", key: "meteorite" },
                    { text: "ğŸ‘ˆ 1ì¸µìœ¼ë¡œ", type: "move", target: "ex1" },
                    { text: "ì˜†ë°© íœ´ê²Œì‹¤(ì›”ë©´ì°¨)ë¡œ ğŸ‘‰", type: "move", target: "rest" }
                ]
            },
            'rest': {
                name: "íœ´ê²Œì‹¤: ì›”ë©´ì°¨ (2F)",
                icon: "ğŸš™",
                basePrompt: `
                    ë„ˆëŠ” íœ´ê²Œì‹¤ ë„ìŠ¨íŠ¸ì•¼.
                    [í•„ìˆ˜ íŒ©íŠ¸] 1.ìœ„ì¹˜(2~3ì „ì‹œì‹¤ ì‚¬ì´), 2.ì›”ë©´ì°¨(ì² ë§ë°”í€´, ê¸°ì¦í’ˆ), 3.ì§€êµ¬ì˜¨(ì •ë©´ ë‘¥ê·¼ìŠ¤í¬ë¦°).
                `,
                buttons: [
                    { text: "ì›”ë©´ì°¨ ë°”í€´ëŠ” ì™œ ì² ë§ì´ì•¼?", type: "ask", key: "lunar_rover" },
                    { text: "ì§€êµ¬ì˜¨ ì‹œìŠ¤í…œì´ ë­ì•¼?", type: "ask", key: "earth_on" },
                    { text: "ì´ ì›”ë©´ì°¨ ì§„ì§œ ë‹¬ì— ê°”ë˜ ê±°ì•¼?", type: "ask", key: "lunar_rover" },
                    { text: "ğŸ‘ˆ 2ì „ì‹œì‹¤ë¡œ", type: "move", target: "ex2" },
                    { text: "3ì „ì‹œì‹¤ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex3" }
                ]
            },
            'ex3': {
                name: "ì œ3ì „ì‹œì‹¤: ìš°ì£¼ (2F)",
                icon: "ğŸš€",
                basePrompt: `
                    ë„ˆëŠ” 3ì „ì‹œì‹¤(ìš°ì£¼) ë„ìŠ¨íŠ¸ì•¼.
                    [í•„ìˆ˜ íŒ©íŠ¸] 1.ë³„ìƒ‰ê¹”(íŒŒë‘>ë¹¨ê°•), 2.ì²œìƒì—´ì°¨ë¶„ì•¼ì§€ë„(ë§Œì› ì§€í), 3.ì ì™¸ì„ ì¹´ë©”ë¼(ì—´ê°ì§€).
                `,
                buttons: [
                    { text: "ë³„ ìƒ‰ê¹”ì€ ì™œ ë‹¬ë¼?", type: "ask", key: "star_life_color" },
                    { text: "ë§Œì›ì§œë¦¬ ì§€í ë’¤ì— ë­ê°€ ìˆì–´?", type: "ask", key: "cheonsang_map" },
                    { text: "ì ì™¸ì„  ì²´í—˜ì´ ë­ì•¼?", type: "ask", key: "infrared_camera" },
                    { text: "íƒœì–‘ ê°ì‹œ ìœ„ì„±ì´ ìˆì–´?", type: "ask", key: "solar_observatory" },
                    { text: "ğŸ‘ˆ íœ´ê²Œì‹¤ë¡œ", type: "move", target: "rest" },
                    { text: "ì²˜ìŒìœ¼ë¡œ ğŸ ", type: "move", target: "lobby" }
                ]
            }
        };

        let currentZoneId = 'lobby';
        let idleTimer = null;

        const chatBox = document.getElementById('chat-box');
        const charIcon = document.getElementById('char-icon');

        // ì§€ì‹ ê²€ìƒ‰ í•¨ìˆ˜
        function getExhibitionContent(dataKey) {
            const item = exhibitionData.find(d => d.id === dataKey);
            if (!item) return null;
            return `[ìë£Œ ì œëª©]: ${item.title}\n[ì„¤ëª…]: ${item.description.basic} / ${item.description.advanced}\n[í•µì‹¬ íŒ©íŠ¸]: ${item.facts ? item.facts.join(', ') : ''}`;
        }

        async function handleUserInput(text, dataKey = null, directAnswers = null) {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(triggerIdleMessage, 20000);
            
            addMessage(text, 'user');

            // 1. [NEW] ëœë¤ ë‹µë³€ ê¸°ëŠ¥ (directAnswersê°€ ë°°ì—´ë¡œ ë“¤ì–´ì˜´)
            if (directAnswers && Array.isArray(directAnswers)) {
                // ë°°ì—´ ì¤‘ í•˜ë‚˜ë¥¼ ëœë¤ìœ¼ë¡œ ë½‘ìŒ
                const randomAns = directAnswers[Math.floor(Math.random() * directAnswers.length)];
                setTimeout(() => {
                    addMessage(randomAns, 'ai');
                    speak(randomAns);
                }, 500);
                return;
            }

            let contextData = "";
            
            // 2. ë²„íŠ¼ í´ë¦­ (ìƒì„¸ ë°ì´í„° ë¡œë“œ)
            if (dataKey) {
                const foundData = getExhibitionContent(dataKey);
                if (foundData) contextData = `[ì°¸ê³  ìë£Œ]\n${foundData}`;
            }

            // 3. AI í˜¸ì¶œ í”„ë¡¬í”„íŠ¸ (ë¡œë¹„ì˜ ê²½ìš° basePromptì— ì „ì²´ ì •ë³´ê°€ ë“¤ì–´ìˆìŒ)
            const finalPrompt = `
                ${zones[currentZoneId].basePrompt}
                
                ${contextData}

                [ì ˆëŒ€ ê·œì¹™]
                1. ìœ„ 'í•„ìˆ˜ ìˆ™ì§€ íŒ©íŠ¸'ì™€ 'ì°¸ê³  ìë£Œ'ì— ìˆëŠ” ë‚´ìš©ë§Œ ì‚¬ì‹¤ë¡œ ë¯¿ì–´. (ì§€ì–´ë‚´ê¸° ê¸ˆì§€)
                2. ìë£Œì— ì—†ëŠ” ë‚´ìš©(ê¹€ì¹˜ì°Œê°œ ë“±)ì€ "ì•ˆë‚´ ë°ìŠ¤í¬ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”"ë¼ê³  í•´.
                3. ë‹µë³€ì€ 3ë¬¸ì¥ ì´ë‚´ë¡œ ì§§ê²Œ.
                4. ë§íˆ¬ëŠ” ë§ˆìŠ¤ì½”íŠ¸(ë˜ë¹„, ë„ê¸°, ìºí‹°)ì²˜ëŸ¼ ê·€ì—½ê³  ì¹œê·¼í•œ ë°˜ë§(~í•´, ~ì•¼).
                
                ê´€ëŒê° ì§ˆë¬¸: "${text}"
            `;

            document.getElementById('status-text').innerText = "ìƒê°í•˜ëŠ” ì¤‘...";
            
            const reply = await callGeminiAPI(text, finalPrompt);
            
            document.getElementById('status-text').innerText = "ë§í•˜ëŠ” ì¤‘...";
            addMessage(reply, 'ai');
            speak(reply);
        }

        async function callGeminiAPI(text, systemPrompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, systemPrompt: systemPrompt })
                });
                const data = await response.json();
                return data.reply || "ì˜¤ë¥˜ê°€ ë‚¬ì–´. ë‹¤ì‹œ ë§í•´ì¤„ë˜?";
            } catch (err) { return "ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì¤˜!"; }
        }

        function speak(text) {
            charIcon.classList.add('talking');
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            window.speechSynthesis.speak(utterance);
            utterance.onend = () => {
                charIcon.classList.remove('talking');
                document.getElementById('status-text').innerText = "ê°™ì´ ë‘˜ëŸ¬ë³´ì!";
            };
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            if(type === 'system') div.className = 'system-msg';
            else div.className = `message ${type === 'user' ? 'user-msg' : 'ai-msg'}`;
            div.innerHTML = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.setZone = (zoneId) => {
            currentZoneId = zoneId;
            const zoneConfig = zones[zoneId];
            document.getElementById('zone-name').innerText = zoneConfig.name;
            document.getElementById('char-icon').innerText = zoneConfig.icon;
            addMessage(`[ì‹œìŠ¤í…œ] ${zoneConfig.name} ë„ì°©!`, 'system');
            
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            zoneConfig.buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.className = `choice-btn ${btn.type === 'move' ? 'move-btn' : ''}`;
                buttonEl.innerText = btn.text;
                buttonEl.onclick = () => {
                    if (btn.type === 'move') setZone(btn.target);
                    // answers(ë°°ì—´)ê°€ ìˆìœ¼ë©´ ëœë¤ ë‹µë³€ ì²˜ë¦¬, ì•„ë‹ˆë©´ AI ê²€ìƒ‰
                    else handleUserInput(btn.text, btn.key, btn.answers);
                };
                container.appendChild(buttonEl);
            });
            clearTimeout(idleTimer);
            idleTimer = setTimeout(triggerIdleMessage, 20000);
        };

        function triggerIdleMessage() {
            const idleMents = ["ê¶ê¸ˆí•œ ê±° ì—†ì–´?", "ë²„íŠ¼ì„ ëˆŒëŸ¬ë´!", "ì¬ë°Œê²Œ ë³´ê³  ìˆì–´?", "í˜¹ì‹œ ë‹¤ë¦¬ ì•„í”„ë©´ ì¢€ ì‰¬ì—ˆë‹¤ ê°€ì."];
            const randomMent = idleMents[Math.floor(Math.random() * idleMents.length)];
            addMessage(randomMent, 'ai');
            speak(randomMent);
        }

        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        sendBtn.addEventListener('click', () => { if(textInput.value) { handleUserInput(textInput.value); textInput.value=''; }});
        textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendBtn.click(); });
        
        document.body.addEventListener('click', () => { clearTimeout(idleTimer); idleTimer = setTimeout(triggerIdleMessage, 20000); });
        
        const micBtn = document.getElementById('mic-btn');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            micBtn.addEventListener('click', () => { window.speechSynthesis.cancel(); micBtn.classList.add('listening'); recognition.start(); });
            recognition.onresult = (e) => { micBtn.classList.remove('listening'); handleUserInput(e.results[0][0].transcript); };
            recognition.onspeechend = () => micBtn.classList.remove('listening');
        } else { micBtn.style.display = 'none'; }

        window.onload = () => { setZone('lobby'); };
    </script>
</body>
</html>
