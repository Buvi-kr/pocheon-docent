<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        body { margin: 0; padding: 0; background: #0b0c15; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; height: 100vh; height: 100dvh; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at bottom, #1a237e 0%, #000000 80%); }
        .stars { position: fixed; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.5; z-index: 0; pointer-events: none; }
        #live2d-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: block; }

        /* --- UI ìŠ¤íƒ€ì¼ --- */
        .hud-area { position: fixed; top: 20px; left: 20px; width: 350px; z-index: 10; display: flex; flex-direction: column; gap: 10px; }
        .zone-badge { align-self: flex-start; background: rgba(79, 195, 247, 0.2); border: 1px solid #4fc3f7; color: #4fc3f7; padding: 5px 12px; border-radius: 15px; font-weight: bold; backdrop-filter: blur(5px); }
        .chat-bubble { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin-bottom: 5px; animation: slideIn 0.4s; }
        .chat-bubble.ai { border-left: 3px solid #4fc3f7; color: #fff; }
        .chat-bubble.user { border-left: 3px solid #ff9800; color: #ffd180; align-self: flex-start; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        .bottom-container { position: fixed; bottom: 0; width: 100%; z-index: 20; display: flex; flex-direction: column; align-items: center; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .choice-scroll-area { display: flex; gap: 10px; overflow-x: auto; width: 100%; justify-content: center; padding: 10px; }
        .choice-scroll-area::-webkit-scrollbar { display: none; }
        .choice-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; white-space: nowrap; }
        .input-bar { display: flex; gap: 10px; width: 90%; max-width: 600px; margin-top: 5px; }
        .input-box { flex: 1; background: rgba(40,40,40,0.8); border: 1px solid #555; border-radius: 25px; padding: 12px; color: white; }
        .icon-btn { width: 48px; height: 48px; border-radius: 50%; border: none; cursor: pointer; }
        #mic-btn { background: #f44336; } #mic-btn.listening { background: #4caf50; animation: pulse 1s infinite; } #send-btn { background: #3f51b5; color: white; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- ë””ë²„ê·¸ ì½˜ì†” --- */
        #debug-box {
            position: fixed; top: 10px; right: 10px; width: 300px; height: auto; max-height: 400px;
            background: rgba(0, 0, 0, 0.85); border: 1px solid #00ff00; color: #00ff00;
            font-family: 'Consolas', monospace; font-size: 11px; padding: 10px; z-index: 1000;
            overflow-y: auto; pointer-events: none; border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>
    <canvas id="live2d-canvas"></canvas>

    <div id="debug-box">ğŸ”§ ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>

    <div class="hud-area" id="hud-container">
        <div class="zone-badge" id="zone-badge">ğŸ›ï¸ ë¡œë¹„</div>
        <div class="chat-bubble ai">
            ì•ˆë…•! ë‚˜ëŠ” AI ë„ìŠ¨íŠ¸ 'í•˜ë£¨'ì•¼! ğŸŒ¸<br>
            í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì— ì˜¨ ê±¸ í™˜ì˜í•´.
        </div>
    </div>

    <div class="bottom-container">
        <div class="choice-scroll-area" id="choice-container"></div>
        <div class="input-bar">
            <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
            <input type="text" class="input-box" id="text-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
            <button class="icon-btn" id="send-btn">â¤</button>
        </div>
    </div>

    <script type="module">
        import { exhibitionData } from './knowledge.js';

        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/Live2D/CubismWebSamples@develop/Samples/Resources/Haru/Haru.model3.json';
        let live2dApp = null;
        let live2dModel = null;
        let mouthInterval = null;

        function logDebug(title, data) {
            const box = document.getElementById('debug-box');
            let text = `[${title}]\n`;
            if (typeof data === 'object') text += JSON.stringify(data, null, 2);
            else text += data;
            box.innerText = text + "\n----------------\n" + box.innerText;
        }

        async function initLive2D() {
            try {
                live2dApp = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    autoStart: true, resizeTo: window, backgroundAlpha: 0 
                });

                if(!window.PIXI.live2d) throw new Error("Plugin not loaded");
                live2dModel = await PIXI.live2d.Live2DModel.from(MODEL_URL);

                resizeModel();
                live2dApp.stage.addChild(live2dModel);
                live2dModel.interactive = true;
                
                live2dModel.on('pointertap', () => {
                    setExpression("happy");
                    // í„°ì¹˜í–ˆì„ ë•Œë„ ëœë¤ í¬ì¦ˆ
                    try { live2dModel.motion('TapBody'); } catch(e){}
                    speak("í—¤í—¤, ê°„ì§€ëŸ¬ì›Œ!");
                });

                logDebug("SYSTEM", "Live2D(Haru) ì´ˆê¸°í™” ì™„ë£Œ");
            } catch (e) { console.error(e); logDebug("ERROR", "Live2D ë¡œë“œ ì‹¤íŒ¨: " + e.message); }
        }

        function resizeModel() {
            if (!live2dModel) return;
            const isMobile = window.innerWidth < 800; 
            live2dModel.anchor.set(0.5, 0);
            live2dModel.x = window.innerWidth / 2;
            if (isMobile) { live2dModel.scale.set(0.42); live2dModel.y = window.innerHeight * 0.15; } 
            else { live2dModel.scale.set(0.50); live2dModel.y = window.innerHeight * 0.05; }
        }
        window.addEventListener('resize', resizeModel);
        initLive2D();

        // --- â˜… [ìˆ˜ì •] í‘œì • ê°„ì†Œí™” (ì›ƒìŒ or ê¸°ë³¸) ---
        function setExpression(emotion) {
            if (!live2dModel) return;

            let expId = "F01"; // ê¸°ë³¸ê°’: ì›ƒìŒ (F01)
            let debugMsg = "F01(Smile)";

            // ì£¼ì„ë‹˜ ìš”ì²­: í™”ë‚˜ê±°ë‚˜ ìŠ¬í”ˆ í‘œì • ì‚­ì œ -> ë¬´ì¡°ê±´ ì›ƒê±°ë‚˜ í‰ë²”í•˜ê²Œ
            if (emotion === "neutral") {
                // í‰ë²”í•œ í‘œì •ì„ ì›í•˜ë©´ í‘œì • ë¦¬ì…‹(í˜¹ì€ F01)
                // HaruëŠ” F01ì´ ì›ƒëŠ”ê±°ë¼, F01ì„ ê¸°ë³¸ìœ¼ë¡œ ì“°ëŠ”ê²Œ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤.
                expId = "F01"; 
                debugMsg = "F01(Neutral->Smile)";
            } else {
                // happy, surprise, angry, sad ë“± ë­ê°€ ë“¤ì–´ì™€ë„ ê·¸ëƒ¥ ì›ƒìŒ(F01)ìœ¼ë¡œ í†µì¼í•˜ê±°ë‚˜
                // ì•½ê°„ì˜ ë³€ì£¼ë¡œ ë†€ëŒ(F06) ì •ë„ë§Œ í—ˆìš©
                if(emotion === "surprise") { expId = "F06"; debugMsg = "F06(Surprise)"; }
                else { expId = "F01"; debugMsg = "F01(Happy)"; }
            }

            try {
                live2dModel.expression(expId);
                logDebug("EXPRESSION", `ìš”ì²­:${emotion} -> ì ìš©:${debugMsg}`);
            } catch(e) { logDebug("EXP_ERROR", e); }
        }

        // --- ìœ„í‚¤ë°±ê³¼ ê²€ìƒ‰ ---
        async function searchWikipedia(query) {
            const cleanQuery = query.replace(/(ì´|ê°€|ì€|ëŠ”|ì„|ë¥¼)?\s*(ë­ì•¼|ì•Œë ¤ì¤˜|ì–´ë–»ê²Œ|ì™œ|ìˆì–´|ì—†ì–´|ì„¤ëª…í•´ì¤˜|ê¶ê¸ˆí•´|\?|\.|!)+/g, "").trim();
            if (cleanQuery.length < 1) return null;
            try {
                const res = await fetch(`https://ko.wikipedia.org/w/api.php?action=query&format=json&prop=extracts&exintro=true&explaintext=true&redirects=1&titles=${cleanQuery}&origin=*`);
                const data = await res.json();
                const pageId = Object.keys(data.query.pages)[0];
                if (pageId === "-1") return null;
                let txt = data.query.pages[pageId].extract;
                return txt.length > 200 ? txt.substring(0, 200) + "..." : txt;
            } catch(e) { return null; }
        }

        // --- STT ---
        const micBtn = document.getElementById('mic-btn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.onstart = () => { micBtn.classList.add('listening'); logDebug("STT", "ë“£ê³  ìˆì–´ìš”..."); };
            recognition.onend = () => micBtn.classList.remove('listening');
            recognition.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('text-input').value = txt;
                handleUserInput(txt);
            };
            micBtn.onclick = () => recognition.start();
        } else { micBtn.style.display = 'none'; }

        // --- ë©”ì¸ ë¡œì§ ---
        async function handleUserInput(text, dataKey = null, answers = null) {
            addMessage(text, 'user');

            if (answers) {
                const ans = answers[Math.floor(Math.random() * answers.length)];
                setTimeout(() => { 
                    setExpression("happy");
                    // â˜… [ìˆ˜ì •] ëŒ€í™”í•  ë•Œ í¬ì¦ˆ ì·¨í•˜ê¸°
                    if(live2dModel) try{ live2dModel.motion('TapBody'); } catch(e){}
                    addMessage(ans, 'ai'); 
                    speak(ans); 
                }, 500);
                return;
            }

            addMessage("ì ì‹œë§Œ... í•˜ë£¨ê°€ ì°¾ì•„ë³¼ê²Œ! ğŸ”", 'ai'); 
            
            let contextData = "";
            let contextSource = "";
            let foundItem = null;

            if (dataKey) foundItem = exhibitionData.find(d => d.id === dataKey);
            else foundItem = exhibitionData.find(d => text.includes(d.title.split('(')[0].trim()));

            if (foundItem) {
                contextSource = "ì „ì‹œë¬¼";
                contextData = `[ì „ì‹œë¬¼] ${foundItem.title}: ${foundItem.description.basic}`;
            } else {
                const wikiText = await searchWikipedia(text);
                if (wikiText) {
                    contextSource = "ìœ„í‚¤ë°±ê³¼";
                    contextData = `[ìœ„í‚¤ë°±ê³¼] ${wikiText}`;
                }
            }

            // â˜… [ìˆ˜ì •] í”„ë¡¬í”„íŠ¸: ê°ì •ì€ 'happy' ì•„ë‹ˆë©´ 'neutral'ë§Œ ë‚´ë†“ìœ¼ë¼ê³  ê°•ì œ
            const prompt = `
                ${zones[currentZoneId].basePrompt}
                [ì§ˆë¬¸]: "${text}"
                ${contextData ? `[ì°¸ê³  ìë£Œ(${contextSource})]: ${contextData}` : "[ì°¸ê³  ìë£Œ ì—†ìŒ]"}
                
                â˜…ì§€ì¹¨â˜…
                1. AI ë„ìŠ¨íŠ¸ 'í•˜ë£¨'ê°€ ë˜ì–´ ë‹µë³€í•´.
                2. ë‹µë³€ í˜•ì‹ì€ **JSON**ë§Œ ì¶œë ¥. ì˜ˆì‹œ: {"emotion": "happy", "reply": "ì‘! ê·¸ê±´~"}
                3. **emotionì€ ë¬´ì¡°ê±´ "happy" ì•„ë‹ˆë©´ "neutral" ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì¨.** (í™”ë‚´ê±°ë‚˜ ìŠ¬í¼í•˜ì§€ ë§ˆ)
                4. ì²œë¬¸/ê³¼í•™ ì§ˆë¬¸ ì•„ë‹ˆë©´ emotion="neutral", reply="ê·¸ê±´ ë‚´ê°€ ëª¨ë¥´ëŠ” ë¶„ì•¼ì•¼." ë¼ê³  ê±°ì ˆ.
                5. ë‹µë³€ 3ë¬¸ì¥ ì´ë‚´ ë°˜ë§.
            `;

            try {
                const responseData = await callGeminiAPI(text, prompt);
                let result = {};
                const cleanJson = responseData.replace(/```json|```/g, "").trim();
                logDebug("GEMINI", cleanJson);

                try { result = JSON.parse(cleanJson); } 
                catch (e) { result = { emotion: "happy", reply: responseData }; }

                // 1. í‘œì • ì„¤ì •
                setExpression(result.emotion || "happy");
                
                // 2. â˜… [ìˆ˜ì •] ë§í•  ë•Œ ë¬´ì¡°ê±´ ëœë¤ í¬ì¦ˆ(Motion) ì‹¤í–‰
                // Haru ëª¨ë¸ì€ 'TapBody' ê·¸ë£¹ì„ ë¶€ë¥´ë©´ ëœë¤í•œ ì œìŠ¤ì²˜(m01~m26) ì¤‘ í•˜ë‚˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
                if(live2dModel) {
                    try { 
                        live2dModel.motion('TapBody'); 
                        logDebug("MOTION", "ìì—°ìŠ¤ëŸ¬ìš´ ì œìŠ¤ì²˜ ì‹¤í–‰(TapBody)");
                    } catch(e) { logDebug("MOTION_ERR", e); }
                }

                addMessage(result.reply, 'ai');
                speak(result.reply);

            } catch (err) {
                console.error(err);
                addMessage("ì˜¤ë¥˜ê°€ ë‚¬ì–´ ã… ã… ", 'ai');
            }
        }

        async function callGeminiAPI(text, systemPrompt) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, systemPrompt: systemPrompt })
                });
                const data = await response.json();
                return data.reply;
            } catch (err) { return JSON.stringify({ emotion: "neutral", reply: "ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ã… ã… " }); }
        }

        // --- â˜… [ìˆ˜ì •] ì…ëª¨ì–‘(Lip Sync) ê°•ë ¥ ë³´ì • ---
        function speak(text) {
            window.speechSynthesis.cancel(); 

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.pitch = 1.2; 
            utterance.rate = 1.1; 

            if (mouthInterval) clearInterval(mouthInterval);

            utterance.onstart = () => {
                logDebug("TTS", "ë§í•˜ê¸° ì‹œì‘");
                // 50msë§ˆë‹¤ ì… ë²Œë¦¬ê¸° ëª…ë ¹ì„ 'ê°•ì œë¡œ' ì£¼ì…
                mouthInterval = setInterval(() => {
                    if (live2dModel) {
                        try { 
                            // 0.3 ~ 1.0 ì‚¬ì´ë¡œ ëœë¤í•˜ê²Œ ì… ë²Œë¦¼
                            const val = Math.random() * 0.7 + 0.3; 
                            
                            // â˜… í•˜ë£¨ ëª¨ë¸ì´ ì‚¬ìš©í•˜ëŠ” íŒŒë¼ë¯¸í„° ì´ë¦„ 2ê°œ ë‹¤ ê³µëµ
                            live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', val); 
                            live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpen', val); 
                        } catch(e){}
                    }
                }, 50); // 0.05ì´ˆë§ˆë‹¤ ê°±ì‹ 
            };

            utterance.onend = () => {
                logDebug("TTS", "ë§í•˜ê¸° ë");
                if (mouthInterval) { clearInterval(mouthInterval); mouthInterval = null; }
                if (live2dModel) {
                    // ì… ë‹¤ë¬¼ê¸°
                    try { 
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0); 
                        live2dModel.internalModel.coreModel.setParameterValueById('ParamMouthOpen', 0); 
                    } catch(e){}
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- ê¸°íƒ€ ë¡œì§ ---
        const zones = {
            'lobby': { name: "ë¡œë¹„ (1F)", basePrompt: "ë„ˆëŠ” 1ì¸µ ë¡œë¹„ ë„ìŠ¨íŠ¸ì•¼.", buttons: [{ text: "ì²œì£¼í˜¸ ì„¤ëª…í•´ì¤˜", type: "chat", answers: ["1ê¸‰ìˆ˜ í˜¸ìˆ˜ì•¼."] }, { text: "1ì „ì‹œì‹¤ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex1" }] },
            'ex1': { name: "ì œ1ì „ì‹œì‹¤ (ì§€êµ¬)", basePrompt: "ë„ˆëŠ” 1ì „ì‹œì‹¤ ë„ìŠ¨íŠ¸ì•¼.", buttons: [{ text: "ì§€êµ¬ êµ¬ì¡°", type: "ask", key: "earth_structure_detail" }, { text: "2ì „ì‹œì‹¤ë¡œ â†—ï¸", type: "move", target: "ex2" }] },
            'ex2': { name: "ì œ2ì „ì‹œì‹¤ (íƒœì–‘ê³„)", basePrompt: "ë„ˆëŠ” 2ì „ì‹œì‹¤ ë„ìŠ¨íŠ¸ì•¼.", buttons: [{ text: "í–‰ì„± íŠ¹ì§•", type: "ask", key: "solar_system_planets" }, { text: "ì˜†ë°©(íœ´ê²Œì‹¤) ğŸ‘‰", type: "move", target: "rest" }] },
            'rest': { name: "íœ´ê²Œì‹¤ (ì›”ë©´ì°¨)", basePrompt: "ë„ˆëŠ” íœ´ê²Œì‹¤ ë„ìŠ¨íŠ¸ì•¼.", buttons: [{ text: "ì›”ë©´ì°¨ ë°”í€´ ë¹„ë°€", type: "ask", key: "lunar_rover" }, { text: "3ì „ì‹œì‹¤ë¡œ ğŸ‘‰", type: "move", target: "ex3" }] },
            'ex3': { name: "ì œ3ì „ì‹œì‹¤ (ìš°ì£¼)", basePrompt: "ë„ˆëŠ” 3ì „ì‹œì‹¤ ë„ìŠ¨íŠ¸ì•¼.", buttons: [{ text: "ë³„ì˜ íƒ„ìƒ", type: "ask", key: "star_life_color" }, { text: "ì²˜ìŒìœ¼ë¡œ ğŸ ", type: "move", target: "lobby" }] }
        };
        let currentZoneId = 'lobby';
        
        const hudContainer = document.getElementById('hud-container');
        const zoneBadge = document.getElementById('zone-badge');

        function addMessage(text, type) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${type}`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            hudContainer.appendChild(bubble);
            hudContainer.scrollTop = hudContainer.scrollHeight;
        }

        window.setZone = (zoneId) => {
            currentZoneId = zoneId;
            const config = zones[zoneId];
            zoneBadge.innerText = `ğŸ“ ${config.name}`;
            addMessage(`${config.name}ì— ë„ì°©í–ˆì–´!`, 'ai');
            speak(`${config.name}ì— ë„ì°©í–ˆì–´!`);
            
            // ë²„íŠ¼ ë Œë”ë§
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            if(config.buttons.length < 3) container.style.justifyContent = 'center';
            else container.style.justifyContent = 'flex-start';
            config.buttons.forEach(btn => {
                const b = document.createElement('button');
                b.innerText = btn.text;
                b.className = `choice-btn ${btn.type === 'move' ? 'move' : ''}`;
                b.onclick = () => { if (btn.type === 'move') setZone(btn.target); else handleUserInput(btn.text, btn.key, btn.answers); };
                container.appendChild(b);
            });
            logDebug("ZONE", config.name);
        };

        window.onload = () => setZone('lobby');
    </script>
</body>
</html>
