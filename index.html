<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    <style>
        /* --- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ìš°ì£¼ í…Œë§ˆ --- */
        body { 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; /* í™”ë©´ ì „ì²´ ë†’ì´ ì‚¬ìš© */
            background: #000; 
            color: white; 
            font-family: 'Pretendard', sans-serif; 
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        /* ë°°ê²½ íš¨ê³¼ */
        .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a237e 0%, #000000 80%); }
        .stars { position: absolute; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.4; z-index: -1; }

        /* 1. ìƒë‹¨: ìºë¦­í„° ë° ì œëª© (ê³ ì •) */
        .header-area { 
            flex: 0 0 auto; /* í¬ê¸° ê³ ì • */
            padding: 15px; 
            text-align: center; 
            background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .character-img { 
            width: 50px; height: 50px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 25px; 
            border: 2px solid #4fc3f7; 
        }
        h1 { margin: 0; font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px #4fc3f7; }

        /* 2. ì¤‘ì•™: ì±„íŒ… ì˜ì—­ (ìœ ë™ì  í¬ê¸°) */
        .chat-area { 
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
        }

        /* ë§í’ì„  ë””ìì¸ */
        .message { padding: 12px 16px; border-radius: 18px; max-width: 80%; line-height: 1.5; font-size: 0.95rem; word-break: break-word; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .user-msg { background: #3949ab; align-self: flex-end; border-bottom-right-radius: 4px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .ai-msg { background: rgba(255,255,255,0.15); align-self: flex-start; border-bottom-left-radius: 4px; color: #e3f2fd; border: 1px solid rgba(255,255,255,0.1); }
        .system-msg { text-align: center; color: #888; font-size: 0.8rem; margin: 10px 0; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px; align-self: center; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* 3. í•˜ë‹¨: ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ (í™•ì‹¤í•˜ê²Œ ì˜¬ë¦¼) */
        .control-area { 
            flex: 0 0 auto; /* í¬ê¸° ê³ ì • */
            padding-bottom: 100px; /* â˜…ì—¬ê¸°ë¥¼ ëŒ€í­ ëŠ˜ë ¤ì„œ ë²„íŠ¼ì„ ìœ„ë¡œ ì˜¬ë¦¼â˜… */
            padding-top: 30px;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            background: linear-gradient(to top, rgba(0,0,0,1) 30%, transparent); 
            z-index: 20;
        }

        /* ë§ˆì´í¬ ë²„íŠ¼ */
        .mic-btn { 
            width: 80px; height: 80px; 
            border-radius: 50%; 
            border: none; 
            background: #f44336; 
            color: white; 
            font-size: 36px; 
            cursor: pointer; 
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.5); 
            transition: transform 0.2s, background 0.3s; 
            display: flex; align-items: center; justify-content: center;
        }
        .mic-btn:active { transform: scale(0.9); }
        .mic-btn.listening { background: #4caf50; box-shadow: 0 0 30px #4caf50; animation: pulse 1.5s infinite; }
        
        .status-text { font-size: 1rem; color: #ddd; margin-bottom: 15px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }

    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>

    <div class="header-area">
        <div class="character-img" id="char-icon">ğŸ¤–</div>
        <h1 id="exhibit-name">ë„ìŠ¨íŠ¸ ì—°ê²° ì¤‘...</h1>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="system-msg">ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ì§ˆë¬¸í•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="control-area">
        <div class="status-text" id="status-text">ëŒ€ê¸° ì¤‘</div>
        <button class="mic-btn" id="mic-btn">ğŸ™ï¸</button>
    </div>

    <script>
        // --- 1. ì „ì‹œë¬¼ ë°ì´í„° ì„¤ì • ---
        const exhibits = {
            'jupiter': { name: 'ëª©ì„± (Jupiter)', icon: 'ğŸª', prompt: 'ë„ˆëŠ” íƒœì–‘ê³„ì˜ ì™•, ëª©ì„±ì´ë‹¤. ì•„ì£¼ ê±°ëŒ€í•˜ê³  ìœ„ì—„ ìˆì§€ë§Œ ì•„ì´ë“¤ì—ê²Œ ì¹œì ˆí•´. ë„ˆì˜ ëŒ€ì ì ê³¼ ìœ„ì„±ë“¤ì— ëŒ€í•´ ìë‘í•´ì¤˜.' },
            'apollo': { name: 'ì•„í´ë¡œ 11í˜¸', icon: 'ğŸš€', prompt: 'ë„ˆëŠ” ì¸ë¥˜ ìµœì´ˆë¡œ ë‹¬ì— ì°©ë¥™í•œ ì•„í´ë¡œ 11í˜¸ì•¼. ëª¨í—˜ì‹¬ì´ ê°•í•˜ê³  ìš©ê°í•œ ë§íˆ¬ë¥¼ ì¨. ë‹¬ ì°©ë¥™ì˜ ìˆœê°„ì„ ìƒìƒí•˜ê²Œ ë§í•´ì¤˜.' },
            'sun': { name: 'íƒœì–‘', icon: 'â˜€ï¸', prompt: 'ë„ˆëŠ” ì´ê¸€ê±°ë¦¬ëŠ” íƒœì–‘ì´ì•¼. ì•„ì£¼ ëœ¨ê²ê³  ì—´ì •ì ì¸ ë§íˆ¬ë¡œ ë„ˆì˜ í‘ì ê³¼ í™ì—¼ì— ëŒ€í•´ ì„¤ëª…í•´ì¤˜.' },
            'default': { name: 'ì•ˆë‚´ ë°ìŠ¤í¬', icon: 'ğŸ’', prompt: 'ë„ˆëŠ” ì²œë¬¸ê³¼í•™ê´€ì˜ ë§ˆìŠ¤ì½”íŠ¸ í¬ìš°ë¦¬ì•¼. ê´€ëŒê°ì—ê²Œ ì¹œì ˆí•˜ê²Œ ì¸ì‚¬í•˜ê³  ë„ì™€ì¤˜.' }
        };

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const currentData = exhibits[id] || exhibits['default'];

        document.getElementById('exhibit-name').innerText = currentData.name;
        document.getElementById('char-icon').innerText = currentData.icon;

        // --- 2. ì±„íŒ… UI í•¨ìˆ˜ ---
        const chatBox = document.getElementById('chat-box');

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type === 'user' ? 'user-msg' : 'ai-msg'}`;
            div.innerText = text;
            chatBox.appendChild(div);
            // ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ë©´ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- 3. ìŒì„± ì¸ì‹ ë° ë¡œì§ ---
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if(SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.interimResults = false; 

            micBtn.addEventListener('click', () => {
                window.speechSynthesis.cancel(); 
                micBtn.classList.add('listening');
                statusText.innerText = "ë“£ê³  ìˆì–´ìš”...";
                recognition.start();
            });

            recognition.onresult = async (event) => {
                const userMsg = event.results[0][0].transcript;
                micBtn.classList.remove('listening');
                statusText.innerText = "ìƒê°í•˜ëŠ” ì¤‘...";
                
                // í™”ë©´ í‘œì‹œ
                addMessage(userMsg, 'user');

                // ë°±ì—”ë“œ í˜¸ì¶œ
                const reply = await callGeminiAPI(userMsg);
                
                // AI ë‹µë³€ ì²˜ë¦¬
                statusText.innerText = "ë‹µë³€ ì¤‘...";
                addMessage(reply, 'ai');
                speak(reply);
            };

            recognition.onerror = () => {
                micBtn.classList.remove('listening');
                statusText.innerText = "ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            };
            
            recognition.onspeechend = () => {
                micBtn.classList.remove('listening');
                statusText.innerText = "ì²˜ë¦¬ ì¤‘...";
            }
        } else {
            addMessage("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í¬ë¡¬/ì‚¬íŒŒë¦¬ ê¶Œì¥)", 'ai');
        }

        // --- 4. ë°±ì—”ë“œ(Gemini) í†µì‹  ---
        async function callGeminiAPI(text) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text,
                        systemPrompt: currentData.prompt 
                    })
                });
                const data = await response.json();
                return data.reply;
            } catch (err) {
                console.error(err);
                return "ì£„ì†¡í•´ìš”, ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•´ìš”.";
            }
        }

        // --- 5. ìŒì„± í•©ì„± (TTS) ---
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            
            window.speechSynthesis.speak(utterance);
            
            utterance.onend = () => {
                statusText.innerText = "ëŒ€ê¸° ì¤‘";
            };
        }
    </script>
</body>
</html>
