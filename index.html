<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Live2D Core Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.jsdelivr.net/gh/datsver/live2d-widget@latest/live2d.min.js"></script>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>

    <style>
        body { margin: 0; background-color: #222; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        
        /* ìº”ë²„ìŠ¤ ì˜ì—­ */
        #canvas-container {
            width: 100vw;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #333 0%, #000 100%); /* ë°°ê²½ ë‹¨ìˆœí™” */
        }
        canvas { display: block; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls {
            height: 20vh;
            width: 100%;
            background: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 10;
            border-top: 1px solid #444;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            cursor: pointer;
            background: #4fc3f7;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: #000;
            transition: 0.2s;
        }
        button:active { transform: scale(0.95); background: #29b6f6; }
        button.secondary { background: #ffeb3b; }

        #status { position: absolute; top: 10px; left: 10px; color: lime; font-family: monospace; background: rgba(0,0,0,0.5); padding: 5px; }
    </style>
</head>
<body>

    <div id="status">ìƒíƒœ: ì´ˆê¸°í™” ì¤‘...</div>

    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
        <button onclick="testMotion()">ğŸ’ƒ ëª¨ì…˜ í…ŒìŠ¤íŠ¸</button>
        <button class="secondary" onclick="testSpeak()">ğŸ’¬ ë§í•˜ê¸° í…ŒìŠ¤íŠ¸</button>
    </div>

    <script>
        // --- ì„¤ì • ì˜ì—­ ---
        // ì‚¬ìš©í•  ëª¨ë¸ ì£¼ì†Œ (íˆìš”ë¦¬)
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/Live2D/CubismWebSamples@develop/Samples/Resources/Hiyori/Hiyori.model3.json';

        // ì „ì—­ ë³€ìˆ˜
        let app, model;
        const statusEl = document.getElementById('status');

        // 1. ì´ˆê¸°í™” í•¨ìˆ˜
        async function init() {
            try {
                // Pixi ì•± ìƒì„±
                app = new PIXI.Application({
                    view: document.getElementById('canvas'),
                    autoStart: true,
                    resizeTo: document.getElementById('canvas-container'), // ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ì¶¤
                    backgroundAlpha: 0 // íˆ¬ëª… ë°°ê²½
                });

                statusEl.innerText = "ìƒíƒœ: ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...";

                // Live2D ëª¨ë¸ ë¡œë“œ (í•œ ì¤„ë¡œ ë!)
                model = await PIXI.live2d.Live2DModel.from(MODEL_URL);

                // ëª¨ë¸ ë°°ì¹˜ (í™”ë©´ ì¤‘ì•™)
                model.anchor.set(0.5);
                model.x = app.screen.width / 2;
                model.y = app.screen.height / 2 + 100; // ì•½ê°„ ì•„ë˜ë¡œ
                model.scale.set(0.25); // í¬ê¸° ì¡°ì ˆ (í™”ë©´ì— ë§ê²Œ ì¡°ì ˆ í•„ìš”)

                // ë§ˆìš°ìŠ¤ ìƒí˜¸ì‘ìš© í™œì„±í™”
                model.interactive = true;

                // í´ë¦­ ì´ë²¤íŠ¸ (ëª¸ í„°ì¹˜ ì‹œ ë°˜ì‘)
                model.on('pointertap', () => {
                    model.motion('TapBody');
                    console.log("í„°ì¹˜ë¨!");
                });

                app.stage.addChild(model);
                
                statusEl.innerText = "ìƒíƒœ: ì¤€ë¹„ ì™„ë£Œ (í„°ì¹˜ ê°€ëŠ¥)";
                console.log("ëª¨ë¸ ë¡œë“œ ì„±ê³µ:", model);

            } catch (err) {
                console.error(err);
                statusEl.innerText = "ì—ëŸ¬ ë°œìƒ! ì½˜ì†” í™•ì¸ í•„ìš”";
                statusEl.style.color = "red";
            }
        }

        init();


        // 2. ëª¨ì…˜ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        function testMotion() {
            if (!model) return;
            // ëª¨ë¸ì´ ê°€ì§„ ëª¨ì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ê°•ì œ ì¬ìƒ
            // 'TapBody'ëŠ” íˆìš”ë¦¬ ëª¨ë¸ì— ë‚´ì¥ëœ ëª¨ì…˜ ì´ë¦„ì…ë‹ˆë‹¤.
            model.motion('TapBody'); 
            statusEl.innerText = "ìƒíƒœ: ëª¨ì…˜ ì¬ìƒ ì¤‘";
        }


        // 3. ë§í•˜ê¸°(ì…ëª¨ì–‘) í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        let talkingInterval;
        function testSpeak() {
            if (!model) return;

            statusEl.innerText = "ìƒíƒœ: ë§í•˜ëŠ” ì¤‘...";
            
            // TTS ì‹¤í–‰
            const text = "ì•ˆë…•í•˜ì„¸ìš”! Live2D ëª¨ë¸ êµ¬í˜„ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤.";
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "ko-KR";
            window.speechSynthesis.speak(utterance);

            // ì… ë²™ê¸‹ê±°ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ (ìˆ˜ë™ êµ¬í˜„)
            if (talkingInterval) clearInterval(talkingInterval);
            
            talkingInterval = setInterval(() => {
                // ì… ë²Œë¦¬ê¸° íŒŒë¼ë¯¸í„° (0.0 ~ 1.0) ëœë¤ ì¡°ì ˆ
                const val = Math.random(); 
                try {
                    model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', val);
                } catch(e) {}
            }, 100);

            // ë§ ëë‚˜ë©´ ì… ë‹¤ë¬¼ê¸°
            utterance.onend = () => {
                clearInterval(talkingInterval);
                try {
                    model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0);
                } catch(e) {}
                statusEl.innerText = "ìƒíƒœ: ëŒ€ê¸° ì¤‘";
            };
        }

        // ì°½ í¬ê¸° ì¡°ì ˆ ëŒ€ì‘
        window.onresize = () => {
            if(app && model) {
                model.x = app.screen.width / 2;
                model.y = app.screen.height / 2 + 100;
            }
        };
    </script>
</body>
</html>
