<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ AI ë„ìŠ¨íŠ¸</title>
    
    <script src="https://cdn.jsdelivr.net/gh/datsver/live2d-widget@latest/live2d.min.js"></script>

    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.2/browser/pixi.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>

    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ ìœ ì§€ */
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: #0b0c15; color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a237e 0%, #000000 90%); }
        .stars { position: absolute; width: 100%; height: 100%; background-image: url('https://cdn.pixabay.com/photo/2016/06/27/22/14/stars-1483324_960_720.png'); opacity: 0.4; z-index: -1; }
        
        .header-area { flex: 0 0 auto; padding: 15px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; z-index: 10; }
        
        /* ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • */
        #live2d-canvas { width: 80px; height: 80px; }
        
        .character-fallback { width: 50px; height: 50px; background: white; border-radius: 50%; border: 2px solid #4fc3f7; display: none; align-items: center; justify-content: center; font-size: 24px; }
        .character-fallback.show { display: flex; }
        .character-fallback.talking { border-color: #ffeb3b; box-shadow: 0 0 15px #ffeb3b; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        .header-text h1 { margin: 0; font-size: 1.1rem; color: #fff; text-shadow: 0 0 10px #4fc3f7; }
        .header-text p { margin: 0; font-size: 0.8rem; color: #4fc3f7; font-weight: bold; }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .message { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; word-break: break-word; animation: popIn 0.3s; }
        .user-msg { background: #3949ab; align-self: flex-end; border-bottom-right-radius: 4px; color: white; }
        .ai-msg { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; color: #e3f2fd; border: 1px solid rgba(255,255,255,0.1); }
        .system-msg { text-align: center; color: #aaa; font-size: 0.85rem; margin: 10px 0; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px; align-self: center; border: 1px solid #555; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-area { flex: 0 0 auto; display: flex; justify-content: center; gap: 10px; padding: 10px 15px 5px 15px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05); }
        .choice-area { flex: 0 0 auto; display: flex; gap: 10px; padding: 5px 15px 10px 15px; overflow-x: auto; background: rgba(0,0,0,0.4); white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .choice-area::-webkit-scrollbar { display: none; }
        .choice-btn { border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; flex-shrink: 0; padding: 8px 16px; }
        .ask-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid #4fc3f7; color: #4fc3f7; }
        .ask-btn:active { background: #4fc3f7; color: black; }
        .ask-btn.visited { opacity: 0.4; border-color: #555; color: #888; background: rgba(0,0,0,0.1); }
        .move-btn { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; color: #ff9800; font-weight: bold; }
        .move-btn:active { background: #ff9800; color: white; }
        .control-area { flex: 0 0 auto; padding: 10px 15px; padding-bottom: max(60px, env(safe-area-inset-bottom)); background: #121212; display: flex; align-items: center; gap: 10px; border-top: 1px solid #333; z-index: 20; }
        .input-box { flex: 1; background: #2c2c2c; border: 1px solid #444; border-radius: 25px; padding: 12px 15px; color: white; font-size: 1rem; outline: none; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #mic-btn { background: #f44336; }
        #mic-btn.listening { background: #4caf50; animation: pulse 1.5s infinite; }
        #send-btn { background: #3949ab; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="stars"></div>

    <div class="header-area">
        <canvas id="live2d-canvas"></canvas>
        <div id="fallback-char" class="character-fallback show">ğŸ°</div>
        <div class="header-text">
            <h1 id="zone-name">ë¡œë¹„</h1>
            <p id="status-text">ê°™ì´ ë‘˜ëŸ¬ë³´ì!</p>
        </div>
    </div>

    <div class="chat-area" id="chat-box">
        <div class="message ai-msg">
            ì•ˆë…•! ë‚˜ëŠ” íˆìš”ë¦¬ì•¼! ğŸ°<br>
            í¬ì²œì•„íŠ¸ë°¸ë¦¬ ì²œë¬¸ê³¼í•™ê´€ì— ì˜¨ ê±¸ í™˜ì˜í•´.
        </div>
    </div>

    <div class="nav-area" id="nav-container"></div>
    <div class="choice-area" id="choice-container"></div>
    <div class="control-area">
        <button class="icon-btn" id="mic-btn">ğŸ™ï¸</button>
        <input type="text" class="input-box" id="text-input" placeholder="ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë´..." autocomplete="off">
        <button class="icon-btn" id="send-btn">â¤</button>
    </div>

    <script type="module">
        import { exhibitionData } from './knowledge.js';

        // --- 1. ê°œì„ ëœ Live2D ì„¤ì • (PixiJS + pixi-live2d-display) ---
        const modelUrl = 'https://cdn.jsdelivr.net/gh/Live2D/CubismWebSamples@develop/Samples/Resources/Hiyori/Hiyori.model3.json';
        const canvasEl = document.getElementById('live2d-canvas');
        const fallbackEl = document.getElementById('fallback-char');
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬
        let app = null;
        let model = null;
        let isLive2DLoaded = false;

        async function initLive2D() {
            try {
                // Pixi Application ìƒì„± (ë°°ê²½ íˆ¬ëª…)
                app = new PIXI.Application({
                    view: canvasEl,
                    autoStart: true,
                    backgroundAlpha: 0,
                    width: 300, // ìº”ë²„ìŠ¤ ë‚´ë¶€ í•´ìƒë„ (CSS í¬ê¸°ì™€ ë‹¤ë¦„)
                    height: 300
                });

                // ëª¨ë¸ ë¡œë“œ (ì—¬ê¸°ê°€ í•µì‹¬: í•œ ì¤„ë¡œ ë¡œë“œ ë!)
                console.log("Live2D ëª¨ë¸ ë¡œë”© ì¤‘...");
                model = await PIXI.live2d.Live2DModel.from(modelUrl);

                // ëª¨ë¸ ìœ„ì¹˜ ë° í¬ê¸° ì„¤ì •
                model.anchor.set(0.5); // ì¤‘ì‹¬ì  ì„¤ì •
                model.x = app.screen.width / 2;
                model.y = app.screen.height / 2 + 50; // ì•½ê°„ ì•„ë˜ë¡œ ë‚´ë¦¼
                model.scale.set(0.12); // ëª¨ë¸ í¬ê¸° ì¡°ì ˆ

                // í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸ (ë„ìŠ¨íŠ¸ ë°˜ì‘)
                model.on('hit', (hitAreas) => {
                    if (hitAreas.includes('Body')) {
                        model.motion('TapBody'); // í„°ì¹˜ ì‹œ ëª¨ì…˜ ì¬ìƒ
                    }
                });

                // ìŠ¤í…Œì´ì§€ì— ì¶”ê°€
                app.stage.addChild(model);

                // ì„±ê³µ ì²˜ë¦¬
                isLive2DLoaded = true;
                fallbackEl.classList.remove('show');
                fallbackEl.style.display = 'none';
                console.log("Live2D ë¡œë“œ ì„±ê³µ!");

            } catch (error) {
                console.error("Live2D ë¡œë“œ ì‹¤íŒ¨ (Fallback ì „í™˜):", error);
                canvasEl.style.display = 'none';
                fallbackEl.classList.add('show');
                fallbackEl.style.display = 'flex';
                isLive2DLoaded = false;
                document.getElementById('status-text').innerText = "2D ëª¨ë“œë¡œ ì „í™˜ë¨";
            }
        }
        
        initLive2D();

        // --- 2. ë§í•˜ê¸° í•¨ìˆ˜ (ì…ëª¨ì–‘ ë™ê¸°í™” í¬í•¨) ---
        function speak(text) {
            let talkingInterval = null;

            // Live2D ì…ëª¨ì–‘ ì›€ì§ì´ê¸° (ëœë¤)
            if (isLive2DLoaded && model) {
                talkingInterval = setInterval(() => {
                    // ì… ë²Œë¦¬ê¸° íŒŒë¼ë¯¸í„° ëœë¤ ì„¤ì • (0.0 ~ 1.0)
                    const randomOpen = Math.random();
                    try {
                        model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', randomOpen);
                    } catch(e) {} 
                }, 100);
            } else {
                fallbackEl.classList.add('talking');
            }

            // TTS ì‹¤í–‰
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            window.speechSynthesis.speak(utterance);
            
            utterance.onend = () => {
                document.getElementById('status-text').innerText = "ê°™ì´ ë‘˜ëŸ¬ë³´ì!";
                
                // ë§í•˜ê¸° ëë‚˜ë©´ ì… ë‹¤ë¬¼ê¸°
                if (isLive2DLoaded && model) {
                    clearInterval(talkingInterval);
                    try {
                        model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0);
                    } catch(e) {}
                } else {
                    fallbackEl.classList.remove('talking'); 
                }
            };
        }

        // --- 3. ê¸°ì¡´ ëŒ€í™” ë° ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ (ìœ ì§€) ---
        const zones = {
            'lobby': {
                name: "ë¡œë¹„ (1F)",
                buttons: [
                    { text: "ì•„íŠ¸ë°¸ë¦¬ëŠ” ì›ë˜ ë­í•˜ë˜ ê³³?", type: "chat", answers: ["ì±„ì„ì¥ì´ì—ˆì–´! ê³¼ê±°ì—” ëŒì„ ìºë˜ ê³³ì´ì§€."] },
                    { text: "ì²œì£¼í˜¸ëŠ” ì–´ë–»ê²Œ ìƒê²¼ì–´?", type: "chat", answers: ["ì±„ì„ í›„ ë‚¨ì€ ì›…ë©ì´ì— ìƒ˜ë¬¼ê³¼ ë¹—ë¬¼ì´ ìœ ì…ë˜ì–´ í˜•ì„±ëœ 1ê¸‰ìˆ˜ í˜¸ìˆ˜ì•¼!"] },
                    { text: "1ì „ì‹œì‹¤(ìš°ì¸¡)ë¡œ ì´ë™ ğŸ‘‰", type: "move", target: "ex1" }
                ]
            },
            'ex1': {
                name: "ì œ1ì „ì‹œì‹¤",
                buttons: [
                    { text: "ì§€êµ¬ ë‚´ë¶€ëŠ” ì–´ë–»ê²Œ ìƒê²¼ì–´?", type: "ask", key: "earth_structure_detail" },
                    { text: "ğŸ‘ˆ ë¡œë¹„ë¡œ", type: "move", target: "lobby" }
                ]
            }
        };

        let currentZoneId = 'lobby';
        const chatBox = document.getElementById('chat-box');

        async function handleUserInput(text, dataKey = null, answers = null) {
            addMessage(text, 'user');
            
            // ì •í•´ì§„ ë‹µë³€ì´ ìˆëŠ” ê²½ìš° (API í˜¸ì¶œ ì—†ì´ ë¹ ë¥¸ ì‘ë‹µ)
            if (answers && Array.isArray(answers)) {
                const randomAns = answers[Math.floor(Math.random() * answers.length)];
                setTimeout(() => { 
                    addMessage(randomAns, 'ai'); 
                    speak(randomAns); 
                    // ëŒ€ë‹µí•  ë•Œ ëœë¤ ëª¨ì…˜ ì¬ìƒ
                    if(isLive2DLoaded && model) {
                        try { model.motion('TapBody'); } catch(e){}
                    }
                }, 500);
                return;
            }

            // Gemini API í˜¸ì¶œ (ê°€ì •)
            document.getElementById('status-text').innerText = "ìƒê°í•˜ëŠ” ì¤‘...";
            const reply = await callGeminiAPI(text, "ë‹µë³€"); // ì‹¤ì œ êµ¬í˜„ í•„ìš”
            
            document.getElementById('status-text').innerText = "ë§í•˜ëŠ” ì¤‘...";
            addMessage(reply, 'ai');
            speak(reply);
        }

        // ê°€ì§œ API í•¨ìˆ˜ (ì‹¤ì œ ì—°ê²° ì‹œ ìˆ˜ì •)
        async function callGeminiAPI(text, systemPrompt) {
            // ì—¬ê¸°ì— ì‹¤ì œ fetch ì½”ë“œê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤. ì§€ê¸ˆì€ ì—ì½”ë§Œ í•©ë‹ˆë‹¤.
            return new Promise(resolve => setTimeout(() => resolve("ë„¤, " + text + "ì— ëŒ€í•´ ì„¤ëª…í•´ì¤„ê²Œ!"), 1000));
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type === 'user' ? 'user-msg' : 'ai-msg'}`;
            div.innerHTML = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function renderButtons(buttons) {
            const navContainer = document.getElementById('nav-container');
            const choiceContainer = document.getElementById('choice-container');
            navContainer.innerHTML = ''; choiceContainer.innerHTML = '';
            
            buttons.forEach(btn => {
                const buttonEl = document.createElement('button');
                buttonEl.innerText = btn.text;
                buttonEl.onclick = () => { if (btn.type === 'move') setZone(btn.target); else handleUserInput(btn.text, btn.key, btn.answers); };
                
                if (btn.type === 'move') { 
                    buttonEl.className = 'choice-btn move-btn'; 
                    navContainer.appendChild(buttonEl); 
                } else { 
                    buttonEl.className = 'choice-btn ask-btn'; 
                    choiceContainer.appendChild(buttonEl); 
                }
            });
        }

        window.setZone = (id) => {
            currentZoneId = id;
            document.getElementById('zone-name').innerText = zones[id].name;
            renderButtons(zones[id].buttons);
        };

        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        sendBtn.addEventListener('click', () => { if(textInput.value) { handleUserInput(textInput.value); textInput.value=''; }});
        
        window.onload = () => { setZone('lobby'); };
    </script>
</body>
</html>

